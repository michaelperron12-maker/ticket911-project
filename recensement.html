<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recensement des Stats — Anomalies Quebec</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0f172a; --bg2: #1e293b; --bg3: #334155;
            --accent: #3b82f6; --green: #22c55e; --red: #ef4444;
            --orange: #f59e0b; --purple: #a855f7; --cyan: #06b6d4;
            --text: #f1f5f9; --dim: #94a3b8; --muted: #64748b;
            --gold: #d4a843;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Inter',system-ui,sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }

        /* === NAVBAR === */
        .navbar {
            position:fixed; top:0; left:0; right:0; z-index:100;
            padding:1rem 0;
            background:rgba(15,23,42,0.92);
            backdrop-filter:blur(12px);
            border-bottom:1px solid #334155;
            transition:box-shadow .3s;
        }
        .navbar.scrolled { box-shadow:0 4px 12px rgba(0,0,0,0.4); }
        .navbar .nav-inner { max-width:1200px; margin:0 auto; padding:0 1.5rem; display:flex; justify-content:space-between; align-items:center; }
        .nav-logo { font-size:1.2rem; font-weight:900; letter-spacing:1px; color:var(--accent); text-decoration:none; }
        .nav-links { display:flex; gap:1.5rem; align-items:center; }
        .nav-links a { color:var(--dim); font-size:.82rem; font-weight:600; text-decoration:none; transition:color .2s; }
        .nav-links a:hover { color:var(--text); }
        .nav-links a.active { color:var(--accent); }
        .nav-cta {
            padding:8px 20px !important; border-radius:10px; font-size:.82rem; font-weight:700;
            background:var(--accent); color:#fff !important; border:none; cursor:pointer; transition:all .3s;
        }
        .nav-cta:hover { background:#2563eb; transform:translateY(-1px); box-shadow:0 4px 12px rgba(37,99,235,0.3); }
        @media(max-width:700px) {
            .nav-links a:not(.nav-cta):not(.active) { display:none; }
        }

        .header {
            text-align:center; padding:5rem 1rem 1.5rem;
            background:linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            border-bottom:1px solid #334155;
        }
        .header h1 { font-size:2rem; font-weight:900; margin-bottom:.3rem; }
        .header h1 span { background:linear-gradient(135deg,var(--accent),var(--cyan));
            -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
        .header p { color:var(--dim); font-size:.85rem; }
        .header .live-badge {
            display:inline-block; background:rgba(34,197,94,.15); color:var(--green);
            padding:3px 10px; border-radius:20px; font-size:.7rem; font-weight:700;
            margin-top:.5rem; letter-spacing:.5px;
        }
        .header .live-badge::before { content:''; display:inline-block; width:6px; height:6px;
            background:var(--green); border-radius:50%; margin-right:5px; animation:pulse 2s infinite; }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.3} }

        .container { max-width:1200px; margin:0 auto; padding:1.5rem; }

        /* Stats row */
        .stats-row { display:grid; grid-template-columns:repeat(4,1fr); gap:.8rem; margin-bottom:1.5rem; }
        .stat-card {
            background:var(--bg2); border-radius:12px; padding:1.2rem;
            border:1px solid #334155; text-align:center; position:relative; overflow:hidden;
        }
        .stat-card::after { content:''; position:absolute; top:0; left:0; right:0; height:3px; }
        .stat-card .num { font-size:2.2rem; font-weight:900; }
        .stat-card .label { color:var(--dim); font-size:.75rem; margin-top:.2rem; text-transform:uppercase; letter-spacing:.5px; }
        .stat-card.total .num { color:var(--accent); }
        .stat-card.total::after { background:var(--accent); }
        .stat-card.high .num { color:var(--red); }
        .stat-card.high::after { background:var(--red); }
        .stat-card.med .num { color:var(--orange); }
        .stat-card.med::after { background:var(--orange); }
        .stat-card.low .num { color:var(--green); }
        .stat-card.low::after { background:var(--green); }

        /* DB stats mini row */
        .db-row { display:grid; grid-template-columns:repeat(3,1fr); gap:.8rem; margin-bottom:2rem; }
        .db-mini {
            background:var(--bg2); border-radius:8px; padding:.8rem 1rem;
            border:1px solid #334155; display:flex; justify-content:space-between; align-items:center;
        }
        .db-mini .db-label { color:var(--muted); font-size:.75rem; }
        .db-mini .db-val { color:var(--cyan); font-weight:700; font-size:.95rem; }

        /* Type breakdown */
        .types-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:.6rem; margin-bottom:2rem; }
        .type-chip {
            background:var(--bg2); border-radius:8px; padding:.7rem 1rem;
            display:flex; justify-content:space-between; align-items:center;
            border:1px solid #334155; font-size:.82rem; cursor:pointer; transition:all .2s;
        }
        .type-chip:hover { border-color:var(--accent); background:#1a2744; }
        .type-chip.active { border-color:var(--accent); background:#1a2744; }
        .type-chip .count { font-weight:800; color:var(--accent); font-size:1rem; }

        /* Section titles */
        .stitle { font-size:1.05rem; font-weight:700; margin:2rem 0 .8rem; color:var(--text);
            display:flex; align-items:center; gap:.5rem; }
        .stitle::before { content:''; width:4px; height:18px; background:var(--accent); border-radius:2px; }
        .stitle .count-tag { font-size:.7rem; background:var(--bg3); padding:2px 8px; border-radius:10px; color:var(--dim); margin-left:.5rem; }

        /* Search */
        .search-box {
            background:var(--bg2); border-radius:12px; padding:1.2rem 1.5rem;
            border:1px solid #334155; margin-bottom:1.5rem;
        }
        .search-box h3 { font-size:.95rem; margin-bottom:.8rem; }
        .search-row { display:flex; gap:.6rem; flex-wrap:wrap; }
        .search-row input, .search-row select {
            flex:1; min-width:120px; padding:.5rem .8rem; border-radius:8px;
            border:1px solid #475569; background:var(--bg); color:var(--text);
            font-family:inherit; font-size:.85rem;
        }
        .search-row select { min-width:140px; }
        .search-row input::placeholder { color:var(--muted); }
        .search-row button {
            padding:.5rem 1.5rem; border-radius:8px; border:none;
            background:var(--accent); color:white; font-weight:700;
            cursor:pointer; font-family:inherit; font-size:.85rem; white-space:nowrap;
        }
        .search-row button:hover { background:#2563eb; }
        .btn-reset { background:#475569!important; }
        .btn-reset:hover { background:#64748b!important; }

        /* Anomaly cards */
        .anomaly-list { display:flex; flex-direction:column; gap:.8rem; }
        .anom-card {
            background:var(--bg2); border-radius:10px; padding:1rem 1.2rem;
            border:1px solid #334155; border-left:4px solid var(--accent);
            transition:all .2s;
        }
        .anom-card:hover { border-color:#475569; }
        .anom-card.high { border-left-color:var(--red); }
        .anom-card.medium { border-left-color:var(--orange); }
        .anom-card.low { border-left-color:var(--green); }

        .anom-head { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:.5rem; gap:1rem; flex-wrap:wrap; }
        .anom-title { font-weight:700; font-size:.9rem; }
        .anom-meta { display:flex; gap:.6rem; flex-wrap:wrap; }
        .badge {
            display:inline-block; padding:2px 8px; border-radius:4px;
            font-size:.65rem; font-weight:700; text-transform:uppercase; letter-spacing:.3px;
        }
        .badge.high { background:rgba(239,68,68,.15); color:var(--red); }
        .badge.medium { background:rgba(245,158,11,.15); color:var(--orange); }
        .badge.low { background:rgba(34,197,94,.15); color:var(--green); }
        .badge.conf { background:rgba(59,130,246,.1); color:var(--accent); }

        .anom-stats {
            display:grid; grid-template-columns:repeat(auto-fit,minmax(100px,1fr));
            gap:.5rem; margin:.6rem 0; padding:.6rem 0;
            border-top:1px solid #293548; border-bottom:1px solid #293548;
        }
        .anom-stat { text-align:center; }
        .anom-stat .val { font-weight:800; font-size:.95rem; font-family:'Courier New',monospace; }
        .anom-stat .lbl { font-size:.65rem; color:var(--muted); text-transform:uppercase; }
        .anom-stat .val.red { color:var(--red); }
        .anom-stat .val.orange { color:var(--orange); }
        .anom-stat .val.green { color:var(--green); }
        .anom-stat .val.blue { color:var(--accent); }

        .anom-defense { color:var(--dim); font-size:.8rem; line-height:1.5; margin:.5rem 0; }
        .anom-ref { color:var(--muted); font-size:.72rem; font-style:italic; }

        .anom-constats {
            margin-top:.6rem; padding:.6rem .8rem; background:var(--bg);
            border-radius:6px; font-size:.75rem; color:var(--dim);
        }
        .anom-constats .ci-title { color:var(--cyan); font-weight:700; margin-bottom:.3rem; font-size:.78rem; }
        .anom-constats .ci-row { display:flex; gap:1.5rem; flex-wrap:wrap; }
        .anom-constats .ci-item { }
        .anom-constats .ci-val { color:var(--text); font-weight:600; }

        /* Pagination */
        .pagination { display:flex; justify-content:center; gap:.5rem; margin:2rem 0; }
        .pagination button {
            padding:.4rem .8rem; border-radius:6px; border:1px solid #475569;
            background:var(--bg2); color:var(--text); cursor:pointer; font-family:inherit;
            font-size:.8rem;
        }
        .pagination button.active { background:var(--accent); border-color:var(--accent); }
        .pagination button:hover:not(.active) { background:var(--bg3); }

        .meta-footer {
            text-align:center; padding:2rem 0; color:var(--muted); font-size:.75rem;
            border-top:1px solid #1e293b; margin-top:2rem;
        }

        .loading { text-align:center; padding:3rem; color:var(--dim); }
        .empty { text-align:center; padding:2rem; color:var(--muted); font-style:italic; }

        /* === TABS === */
        .tabs-bar {
            display:flex; gap:0; margin-bottom:1.5rem; border-bottom:2px solid #334155;
        }
        .tab-btn {
            padding:.7rem 1.5rem; border:none; background:none; color:var(--dim);
            font-family:inherit; font-size:.85rem; font-weight:700; cursor:pointer;
            border-bottom:3px solid transparent; margin-bottom:-2px; transition:all .2s;
            white-space:nowrap;
        }
        .tab-btn:hover { color:var(--text); background:rgba(59,130,246,.05); }
        .tab-btn.active { color:var(--accent); border-bottom-color:var(--accent); }
        .tab-btn .tab-count {
            display:inline-block; background:var(--bg3); padding:1px 7px; border-radius:10px;
            font-size:.7rem; margin-left:.4rem; color:var(--dim);
        }
        .tab-btn.active .tab-count { background:rgba(59,130,246,.2); color:var(--accent); }
        .tab-panel { display:none; }
        .tab-panel.active { display:block; }

        /* Blitz cards */
        .blitz-card {
            background:var(--bg2); border-radius:10px; padding:1rem 1.2rem;
            border:1px solid #334155; border-left:4px solid var(--red);
            margin-bottom:.8rem; transition:all .2s;
        }
        .blitz-card.medium { border-left-color:var(--orange); }
        .blitz-card.low { border-left-color:var(--green); }
        .blitz-head { display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:.5rem; }
        .blitz-title { font-weight:800; font-size:1rem; }
        .blitz-date { color:var(--cyan); font-size:.85rem; font-weight:600; }
        .blitz-metrics { display:flex; gap:1.5rem; margin:.6rem 0; flex-wrap:wrap; }
        .blitz-metric { text-align:center; }
        .blitz-metric .bm-val { font-weight:900; font-size:1.1rem; font-family:'Courier New',monospace; }
        .blitz-metric .bm-val.red { color:var(--red); }
        .blitz-metric .bm-val.orange { color:var(--orange); }
        .blitz-metric .bm-val.blue { color:var(--accent); }
        .blitz-metric .bm-lbl { font-size:.65rem; color:var(--muted); text-transform:uppercase; }

        /* Day pattern bars */
        .dow-chart { display:flex; gap:.4rem; align-items:flex-end; height:160px; margin:1rem 0; }
        .dow-bar-wrap { flex:1; display:flex; flex-direction:column; align-items:center; height:100%; justify-content:flex-end; }
        .dow-bar {
            width:100%; border-radius:4px 4px 0 0; min-height:4px;
            background:var(--accent); transition:height .5s ease;
        }
        .dow-bar.spike { background:var(--red); }
        .dow-bar.quiet { background:var(--green); }
        .dow-label { font-size:.65rem; color:var(--dim); margin-top:.3rem; text-align:center; }
        .dow-pct { font-size:.7rem; font-weight:700; color:var(--text); margin-bottom:.2rem; }

        /* Pattern card */
        .pattern-card {
            background:var(--bg2); border-radius:10px; padding:1rem 1.2rem;
            border:1px solid #334155; margin-bottom:.8rem;
        }
        .pattern-card .pc-title { font-weight:700; font-size:.9rem; margin-bottom:.5rem; }
        .pattern-card .pc-info { color:var(--dim); font-size:.8rem; line-height:1.5; }

        @media(max-width:700px) {
            .stats-row { grid-template-columns:repeat(2,1fr); }
            .db-row { grid-template-columns:1fr; }
            .search-row { flex-direction:column; }
            .anom-stats { grid-template-columns:repeat(3,1fr); }
        }
    </style>
</head>
<body>

<!-- === NAVBAR === -->
<nav class="navbar">
    <div class="nav-inner">
        <a href="./" class="nav-logo">AITicketInfo</a>
        <div class="nav-links">
            <a href="./">Scanner</a>
            <a href="recensement" class="active">Recensement</a>
            <a href="./#scanner" class="nav-cta">Analyser mon ticket</a>
        </div>
    </div>
</nav>

<div class="header">
    <h1>Recensement des <span>Stats</span></h1>
    <p>Detection d'anomalies statistiques — Contraventions Quebec</p>
    <div class="live-badge">LIVE — DONNEES REELLES</div>
</div>

<div class="container">

    <!-- Stats globales -->
    <div class="stats-row">
        <div class="stat-card total"><div class="num" id="s-total">—</div><div class="label">Anomalies actives</div></div>
        <div class="stat-card high"><div class="num" id="s-high">—</div><div class="label">Critiques</div></div>
        <div class="stat-card med"><div class="num" id="s-med">—</div><div class="label">Moyennes</div></div>
        <div class="stat-card low"><div class="num" id="s-low">—</div><div class="label">Faibles</div></div>
    </div>

    <!-- DB stats -->
    <div class="db-row">
        <div class="db-mini"><span class="db-label">Constats analyses</span><span class="db-val" id="db-constats">—</span></div>
        <div class="db-mini"><span class="db-label">Jurisprudence tickets</span><span class="db-val" id="db-juris">—</span></div>
        <div class="db-mini"><span class="db-label">Radars actifs</span><span class="db-val" id="db-radars">—</span></div>
    </div>

    <!-- === TABS === -->
    <div class="tabs-bar">
        <button class="tab-btn active" onclick="switchTab('anomalies')">Anomalies <span class="tab-count" id="tab-count-anom">—</span></button>
        <button class="tab-btn" onclick="switchTab('blitz')">Blitz <span class="tab-count" id="tab-count-blitz">—</span></button>
        <button class="tab-btn" onclick="switchTab('patterns')">Patterns jour/semaine <span class="tab-count" id="tab-count-pat">—</span></button>
        <button class="tab-btn" onclick="switchTab('ocr')">Tickets scannes <span class="tab-count" id="tab-count-ocr">—</span></button>
    </div>

    <!-- ═══ TAB: ANOMALIES ═══ -->
    <div class="tab-panel active" id="panel-anomalies">
        <!-- Types -->
        <div class="stitle">Anomalies par type <span class="count-tag" id="type-count"></span></div>
        <div class="types-grid" id="types-grid"></div>

        <!-- Search -->
        <div class="search-box">
            <h3>Filtrer les anomalies</h3>
            <div class="search-row">
                <input type="text" id="inp-lieu" placeholder="Ville ou code (ex: Quebec, 66023)">
                <input type="text" id="inp-article" placeholder="Article (ex: 463)">
                <select id="sel-severity">
                    <option value="">Toutes severites</option>
                    <option value="high">Critiques</option>
                    <option value="medium">Moyennes</option>
                    <option value="low">Faibles</option>
                </select>
                <select id="sel-type">
                    <option value="">Tous les types</option>
                </select>
                <button onclick="loadDetails(1)">Filtrer</button>
                <button class="btn-reset" onclick="resetFilters()">Reset</button>
            </div>
        </div>

        <!-- Results -->
        <div class="stitle">Anomalies detectees <span class="count-tag" id="results-count"></span></div>
        <div class="anomaly-list" id="anomaly-list">
            <div class="loading">Chargement...</div>
        </div>
        <div class="pagination" id="pagination"></div>
    </div>

    <!-- ═══ TAB: BLITZ ═══ -->
    <div class="tab-panel" id="panel-blitz">
        <div class="stitle">Operations blitz detectees <span class="count-tag" id="blitz-results-count"></span></div>
        <p style="color:var(--dim);font-size:.8rem;margin-bottom:1rem;">
            Jours ou une municipalite a eu un pic massif de constats (30+ par jour, 3x+ la moyenne).
            Indicatif d'operations policiere ciblees.
        </p>

        <!-- Blitz stats -->
        <div class="stats-row" style="grid-template-columns:repeat(4,1fr);margin-bottom:1rem;">
            <div class="stat-card high"><div class="num" id="blitz-high">—</div><div class="label">Blitz critiques</div></div>
            <div class="stat-card med"><div class="num" id="blitz-med">—</div><div class="label">Blitz moyens</div></div>
            <div class="stat-card low"><div class="num" id="blitz-low">—</div><div class="label">Blitz faibles</div></div>
            <div class="stat-card total"><div class="num" id="blitz-max">—</div><div class="label">Max constats/jour</div></div>
        </div>

        <!-- Blitz filter -->
        <div class="search-box">
            <div class="search-row">
                <input type="text" id="blitz-inp-muni" placeholder="Municipalite (ex: Montreal)">
                <select id="blitz-sel-sev">
                    <option value="">Toutes severites</option>
                    <option value="high">Critiques</option>
                    <option value="medium">Moyens</option>
                    <option value="low">Faibles</option>
                </select>
                <button onclick="loadBlitz(1)">Filtrer</button>
                <button class="btn-reset" onclick="document.getElementById('blitz-inp-muni').value='';document.getElementById('blitz-sel-sev').value='';loadBlitz(1);">Reset</button>
            </div>
        </div>

        <div id="blitz-list"><div class="loading">Cliquez sur l'onglet pour charger...</div></div>
        <div class="pagination" id="blitz-pagination"></div>
    </div>

    <!-- ═══ TAB: PATTERNS ═══ -->
    <div class="tab-panel" id="panel-patterns">
        <div class="stitle">Patterns jour de semaine <span class="count-tag" id="pat-results-count"></span></div>
        <p style="color:var(--dim);font-size:.8rem;margin-bottom:1rem;">
            Distribution des constats par jour de semaine. Identifie les municipalites ou certains
            jours concentrent anormalement plus de tickets (z-score &ge; 2.5).
        </p>

        <!-- Global distribution -->
        <div class="pattern-card">
            <div class="pc-title">Distribution provinciale (toutes municipalites)</div>
            <div class="dow-chart" id="global-dow-chart"></div>
        </div>

        <!-- Patterns filter -->
        <div class="search-box" style="margin-top:1rem;">
            <div class="search-row">
                <input type="text" id="pat-inp-muni" placeholder="Municipalite (ex: Laval)">
                <button onclick="loadPatterns(1)">Filtrer</button>
                <button class="btn-reset" onclick="document.getElementById('pat-inp-muni').value='';loadPatterns(1);">Reset</button>
            </div>
        </div>

        <div id="patterns-list"><div class="loading">Cliquez sur l'onglet pour charger...</div></div>
        <div class="pagination" id="pat-pagination"></div>
    </div>

    <!-- ═══ TAB: OCR ═══ -->
    <div class="tab-panel" id="panel-ocr">
        <div class="stitle">Donnees des tickets scannes (OCR)</div>
        <p style="color:var(--dim);font-size:.8rem;margin-bottom:1rem;">
            Au fur et a mesure que les clients scannent leurs tickets, on accumule les donnees:
            matricule policier, rue exacte, corps de police, appareil de mesure, etc.
            Ces donnees ne sont PAS dans les fichiers publics du Quebec.
        </p>

        <div class="stats-row" style="grid-template-columns:repeat(3,1fr);margin-bottom:1rem;">
            <div class="stat-card total"><div class="num" id="ocr-total">—</div><div class="label">Tickets scannes</div></div>
            <div class="stat-card high"><div class="num" id="ocr-matricules">—</div><div class="label">Matricules uniques</div></div>
            <div class="stat-card med"><div class="num" id="ocr-rues">—</div><div class="label">Rues indexees</div></div>
        </div>

        <div id="ocr-content"><div class="loading">Cliquez sur l'onglet pour charger...</div></div>
    </div>

    <div class="meta-footer" id="meta-footer"></div>
</div>

<script>
const BASE = window.location.pathname.replace(/\/recensement\.html.*/, '').replace(/\/recensement$/, '');
const API = BASE + '/api/recensement';

const TYPE_LABELS = {
    'anomalie_saisonniere': 'Anomalie saisonniere',
    'article_surrepresente': 'Article surrepresente',
    'hotspot_geo': 'Hotspot geographique',
    'spike_fin_mois': 'Quota fin de mois',
    'taux_acquittement': 'Taux acquittement',
    'radar_disproportionne': 'Radar disproportionne',
    'piege_vitesse': 'Piege a vitesse',
    'pattern_jour': 'Pattern jour semaine',
    'vehicule_lourd_anomal': 'Vehicule lourd cible',
    'intervention_anomale': 'Intervention anomale',
    'concentration_articles': 'Concentration article',
    'tendance_annuelle': 'Tendance annuelle',
    'heure_pointe_anomale': 'Heure de pointe',
    'amende_disproportionnee': 'Amende disproportionnee',
    'collision_vs_enforcement': 'Constats vs accidents',
    'tolerance_radar': 'Tolerance radar',
    'points_anormaux': 'Points inaptitude',
    'spike_debut_mois': 'Objectif debut mois',
    'exces_distribution': 'Distribution exces',
    'multi_infraction': 'Multi-infraction',
    'recidive_municipale': 'Recidive municipale',
    'weekend_ratio': 'Ratio week-end',
    'loi_anomale': 'Loi anomale',
    'vitesse_benford': 'Benford vitesse',
    'bracketing_vitesse': 'Bracketing seuils',
    'blitz_vacances': 'Blitz vacances',
    'zone_scolaire_hors_heures': 'Zone scolaire',
    'profilage_veil_darkness': 'Profilage racial',
    'blitz_daily': 'Blitz quotidien',
    'pattern_jour_semaine': 'Pattern jour semaine',
};

const TYPE_ICONS = {
    'anomalie_saisonniere': '&#9670;',
    'article_surrepresente': '&#9733;',
    'hotspot_geo': '&#9679;',
    'spike_fin_mois': '&#9650;',
    'taux_acquittement': '&#9745;',
    'radar_disproportionne': '&#9673;',
    'piege_vitesse': '&#9889;',
    'pattern_jour': '&#9683;',
    'vehicule_lourd_anomal': '&#128666;',
    'intervention_anomale': '&#128270;',
    'concentration_articles': '&#127919;',
    'tendance_annuelle': '&#128200;',
    'heure_pointe_anomale': '&#9200;',
    'amende_disproportionnee': '&#128176;',
    'collision_vs_enforcement': '&#128680;',
    'tolerance_radar': '&#128207;',
    'points_anormaux': '&#128293;',
    'spike_debut_mois': '&#128197;',
    'exces_distribution': '&#128202;',
    'multi_infraction': '&#128279;',
    'recidive_municipale': '&#128257;',
    'weekend_ratio': '&#127774;',
    'loi_anomale': '&#9878;',
    'vitesse_benford': '&#128290;',
    'bracketing_vitesse': '&#128207;',
    'blitz_vacances': '&#127958;',
    'zone_scolaire_hors_heures': '&#127979;',
    'profilage_veil_darkness': '&#128101;',
    'blitz_daily': '&#128680;',
    'pattern_jour_semaine': '&#128197;',
};

let currentTypeFilter = '';

async function loadSummary() {
    try {
        const r = await fetch(API);
        const d = await r.json();

        document.getElementById('s-total').textContent = (d.total_anomalies||0).toLocaleString('fr-CA');
        document.getElementById('s-high').textContent = (d.high||0).toLocaleString('fr-CA');
        document.getElementById('s-med').textContent = (d.medium||0).toLocaleString('fr-CA');
        document.getElementById('s-low').textContent = (d.low||0).toLocaleString('fr-CA');

        // Types
        const tg = document.getElementById('types-grid');
        const sel = document.getElementById('sel-type');
        tg.innerHTML = '';
        const types = Object.entries(d.by_type || {}).sort((a,b) => b[1]-a[1]);
        document.getElementById('type-count').textContent = types.length + ' types';
        for (const [type, count] of types) {
            const chip = document.createElement('div');
            chip.className = 'type-chip';
            chip.innerHTML = `<span>${TYPE_LABELS[type]||type}</span><span class="count">${count}</span>`;
            chip.onclick = () => { toggleType(type, chip); };
            tg.appendChild(chip);
            sel.innerHTML += `<option value="${type}">${TYPE_LABELS[type]||type}</option>`;
        }

        // Meta
        document.getElementById('meta-footer').innerHTML =
            `Dernier calcul: ${d.last_computed ? new Date(d.last_computed).toLocaleString('fr-CA') : '—'} | ` +
            `Batch: ${d.last_batch||'—'} | Duree: ${d.last_duration_s||'—'}s | ` +
            `Donnees: constats CRQ, radars QC, jurisprudence CanLII+SOQUIJ`;

    } catch(e) { console.error(e); }
}

function toggleType(type, chip) {
    document.querySelectorAll('.type-chip').forEach(c => c.classList.remove('active'));
    if (currentTypeFilter === type) {
        currentTypeFilter = '';
        document.getElementById('sel-type').value = '';
    } else {
        currentTypeFilter = type;
        chip.classList.add('active');
        document.getElementById('sel-type').value = type;
    }
    loadDetails(1);
}

function resetFilters() {
    document.getElementById('inp-lieu').value = '';
    document.getElementById('inp-article').value = '';
    document.getElementById('sel-severity').value = '';
    document.getElementById('sel-type').value = '';
    currentTypeFilter = '';
    document.querySelectorAll('.type-chip').forEach(c => c.classList.remove('active'));
    loadDetails(1);
}

async function loadDetails(page) {
    const list = document.getElementById('anomaly-list');
    list.innerHTML = '<div class="loading">Chargement des anomalies...</div>';

    const params = new URLSearchParams();
    params.set('page', page);
    params.set('per_page', 30);

    const sev = document.getElementById('sel-severity').value;
    const typ = document.getElementById('sel-type').value || currentTypeFilter;
    if (sev) params.set('severity', sev);
    if (typ) params.set('type', typ);

    // Si lieu ou article, utiliser l'endpoint match
    const lieu = document.getElementById('inp-lieu').value.trim();
    const article = document.getElementById('inp-article').value.trim();

    let url = API + '/details?' + params;

    try {
        const r = await fetch(url);
        const d = await r.json();

        if (d.error) { list.innerHTML = `<div class="empty">Erreur: ${d.error}</div>`; return; }

        // DB stats
        if (d.db_stats) {
            document.getElementById('db-constats').textContent = (d.db_stats.total_constats||0).toLocaleString('fr-CA');
            document.getElementById('db-juris').textContent = (d.db_stats.total_jurisprudence||0).toLocaleString('fr-CA');
            document.getElementById('db-radars').textContent = (d.db_stats.total_radars_actifs||0).toLocaleString('fr-CA');
        }

        document.getElementById('results-count').textContent = d.total + ' resultats';

        if (!d.anomalies || d.anomalies.length === 0) {
            list.innerHTML = '<div class="empty">Aucune anomalie trouvee.</div>';
            document.getElementById('pagination').innerHTML = '';
            return;
        }

        // Filter by lieu/article client-side if needed
        let anomalies = d.anomalies;
        if (lieu) anomalies = anomalies.filter(a => a.region === lieu);
        if (article) anomalies = anomalies.filter(a => a.article === article);

        list.innerHTML = '';
        for (const a of anomalies) {
            const card = document.createElement('div');
            card.className = `anom-card ${a.severity}`;

            let statsHTML = `
                <div class="anom-stat"><div class="val ${a.z_score >= 3.5 ? 'red' : a.z_score >= 2.5 ? 'orange' : 'blue'}">${a.z_score ? a.z_score.toFixed(1) : '—'}</div><div class="lbl">Z-Score</div></div>
                <div class="anom-stat"><div class="val">${a.deviation_pct ? (a.deviation_pct > 0 ? '+' : '') + a.deviation_pct.toFixed(0) + '%' : '—'}</div><div class="lbl">Deviation</div></div>
                <div class="anom-stat"><div class="val blue">${a.observed ? a.observed.toLocaleString('fr-CA',{maximumFractionDigits:1}) : '—'}</div><div class="lbl">Observe</div></div>
                <div class="anom-stat"><div class="val">${a.expected ? a.expected.toLocaleString('fr-CA',{maximumFractionDigits:1}) : '—'}</div><div class="lbl">Attendu</div></div>
                <div class="anom-stat"><div class="val">${a.sample_size ? a.sample_size.toLocaleString('fr-CA') : '—'}</div><div class="lbl">Echantillon</div></div>
            `;
            if (a.period_start) {
                statsHTML += `<div class="anom-stat"><div class="val">${a.period_start}</div><div class="lbl">Periode</div></div>`;
            }

            // Constats enrichment
            let constatsHTML = '';
            if (a.constats_info) {
                const ci = a.constats_info;
                constatsHTML = `
                    <div class="anom-constats">
                        <div class="ci-title">Donnees constats — ${a.nom_municipalite || 'Lieu ' + a.region}</div>
                        <div class="ci-row">
                            <div class="ci-item">Total: <span class="ci-val">${ci.total_constats.toLocaleString('fr-CA')}</span></div>
                            <div class="ci-item">Periode: <span class="ci-val">${ci.premiere_date || '?'} a ${ci.derniere_date || '?'}</span></div>
                            <div class="ci-item">Articles distincts: <span class="ci-val">${ci.nb_articles_distincts}</span></div>
                            <div class="ci-item">Loi: <span class="ci-val">${ci.loi_freq || '—'}</span></div>
                            <div class="ci-item">Description: <span class="ci-val">${ci.description_freq || '—'}</span></div>
                            <div class="ci-item">Type: <span class="ci-val">${ci.type_intervention_freq || '—'}</span></div>
                            ${ci.amende_moyenne ? `<div class="ci-item">Amende moy: <span class="ci-val">${ci.amende_moyenne}$</span></div>` : ''}
                            ${ci.points_moyens ? `<div class="ci-item">Points moy: <span class="ci-val">${ci.points_moyens}</span></div>` : ''}
                            ${ci.nb_avec_vitesse ? `<div class="ci-item">Avec vitesse: <span class="ci-val">${ci.nb_avec_vitesse.toLocaleString('fr-CA')}</span></div>` : ''}
                        </div>
                    </div>`;
            }

            // Computation details
            let detailsHTML = '';
            if (a.details && typeof a.details === 'object') {
                const keys = Object.keys(a.details).filter(k => !['mean_ratio','std_ratio'].includes(k));
                if (keys.length > 0) {
                    const items = keys.slice(0, 8).map(k => {
                        let v = a.details[k];
                        if (typeof v === 'object') v = JSON.stringify(v).substring(0,60);
                        if (typeof v === 'number') v = v.toLocaleString('fr-CA', {maximumFractionDigits:2});
                        return `<span style="margin-right:1rem">${k}: <strong>${v}</strong></span>`;
                    }).join('');
                    detailsHTML = `<div style="font-size:.7rem;color:var(--muted);margin-top:.3rem;line-height:1.6">${items}</div>`;
                }
            }

            card.innerHTML = `
                <div class="anom-head">
                    <div class="anom-title">${TYPE_ICONS[a.type]||''} ${TYPE_LABELS[a.type]||a.type}${a.region ? ' — ' + (a.nom_municipalite || 'Lieu ' + a.region) : ''}${a.mrc ? ' (MRC: ' + a.mrc + ')' : ''}${a.article ? ' — Art. ' + a.article : ''}</div>
                    ${a.nom_municipalite ? '<div style="color:var(--dim);font-size:.72rem;margin-top:2px;">Code: '+a.region+(a.region_admin?' | Région: '+a.region_admin:'')+(a.population?' | Pop: '+Number(a.population).toLocaleString('fr-CA'):'')+'</div>' : ''}
                    <div class="anom-meta">
                        <span class="badge ${a.severity}">${a.severity}</span>
                        <span class="badge conf">${a.confidence || '?'}</span>
                    </div>
                </div>
                <div class="anom-stats">${statsHTML}</div>
                <div class="anom-defense">${a.defense_text || ''}</div>
                <div class="anom-ref">${a.legal_ref || ''}</div>
                ${detailsHTML}
                ${constatsHTML}
            `;
            list.appendChild(card);
        }

        // Pagination
        const pag = document.getElementById('pagination');
        pag.innerHTML = '';
        if (d.total_pages > 1) {
            for (let p = 1; p <= Math.min(d.total_pages, 10); p++) {
                const btn = document.createElement('button');
                btn.textContent = p;
                if (p === d.page) btn.className = 'active';
                btn.onclick = () => loadDetails(p);
                pag.appendChild(btn);
            }
            if (d.total_pages > 10) {
                const sp = document.createElement('span');
                sp.textContent = `... ${d.total_pages}`;
                sp.style.cssText = 'color:var(--muted);padding:.4rem';
                pag.appendChild(sp);
            }
        }

    } catch(e) {
        list.innerHTML = `<div class="empty">Erreur: ${e.message}</div>`;
    }
}

// ═══ TAB SYSTEM ═══
let tabsLoaded = { anomalies: false, blitz: false, patterns: false, ocr: false };

function switchTab(name) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    document.querySelector(`[onclick="switchTab('${name}')"]`).classList.add('active');
    document.getElementById('panel-' + name).classList.add('active');

    if (!tabsLoaded[name]) {
        tabsLoaded[name] = true;
        if (name === 'blitz') loadBlitz(1);
        else if (name === 'patterns') loadPatterns(1);
        else if (name === 'ocr') loadOCR();
    }
}

// ═══ BLITZ ═══
async function loadBlitz(page) {
    const list = document.getElementById('blitz-list');
    list.innerHTML = '<div class="loading">Chargement des blitz...</div>';

    const params = new URLSearchParams();
    params.set('page', page);
    params.set('per_page', 30);
    const muni = document.getElementById('blitz-inp-muni').value.trim();
    const sev = document.getElementById('blitz-sel-sev').value;
    if (muni) params.set('municipality', muni);
    if (sev) params.set('severity', sev);

    try {
        const r = await fetch(BASE + '/api/blitz?' + params);
        const d = await r.json();
        if (d.error) { list.innerHTML = `<div class="empty">Erreur: ${d.error}</div>`; return; }

        // Stats
        document.getElementById('tab-count-blitz').textContent = d.total || 0;
        document.getElementById('blitz-results-count').textContent = d.total + ' blitz';
        if (d.stats) {
            document.getElementById('blitz-high').textContent = d.stats.high || 0;
            document.getElementById('blitz-med').textContent = d.stats.medium || 0;
            document.getElementById('blitz-low').textContent = d.stats.low || 0;
            document.getElementById('blitz-max').textContent = d.stats.max_constats ? Math.round(d.stats.max_constats) : '—';
        }

        if (!d.blitz_events || d.blitz_events.length === 0) {
            list.innerHTML = '<div class="empty">Aucun blitz detecte. Executez le detecteur blitz_daily d\'abord.</div>';
            return;
        }

        list.innerHTML = '';
        for (const b of d.blitz_events) {
            const card = document.createElement('div');
            card.className = `blitz-card ${b.severity}`;
            const ratio = b.ratio || (b.avg_daily > 0 ? (b.nb_constats / b.avg_daily).toFixed(1) : '?');
            card.innerHTML = `
                <div class="blitz-head">
                    <div>
                        <div class="blitz-title">${b.nom_municipalite || b.lieu}${b.mrc ? ' <span style="color:var(--dim);font-size:.75rem">(MRC: '+b.mrc+')</span>' : ''}</div>
                        <div class="blitz-date">${b.date || '—'} — ${b.jour || '—'}</div>
                    </div>
                    <div class="anom-meta">
                        <span class="badge ${b.severity}">${b.severity}</span>
                        <span class="badge conf">${b.blitz_type || 'standard'}</span>
                        ${b.consecutive_days > 1 ? '<span class="badge" style="background:rgba(168,85,247,.15);color:var(--purple)">'+b.consecutive_days+' jours</span>' : ''}
                    </div>
                </div>
                <div class="blitz-metrics">
                    <div class="blitz-metric"><div class="bm-val red">${Math.round(b.nb_constats)}</div><div class="bm-lbl">Constats ce jour</div></div>
                    <div class="blitz-metric"><div class="bm-val">${b.avg_daily ? b.avg_daily.toFixed(1) : '—'}</div><div class="bm-lbl">Moyenne/jour</div></div>
                    <div class="blitz-metric"><div class="bm-val orange">${ratio}x</div><div class="bm-lbl">Ratio</div></div>
                    <div class="blitz-metric"><div class="bm-val blue">${b.z_score ? b.z_score.toFixed(1) : '—'}</div><div class="bm-lbl">Z-Score</div></div>
                </div>
                <div class="anom-defense">${b.defense_text || ''}</div>
            `;
            list.appendChild(card);
        }

        // Pagination
        renderPagination('blitz-pagination', d.page, d.total_pages, loadBlitz);

    } catch(e) {
        list.innerHTML = `<div class="empty">Erreur: ${e.message}</div>`;
    }
}

// ═══ DAY PATTERNS ═══
const JOURS = ['Dim','Lun','Mar','Mer','Jeu','Ven','Sam'];
const JOURS_FULL = ['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'];

function renderDowChart(containerId, distribution) {
    const container = document.getElementById(containerId);
    if (!container) return;
    container.innerHTML = '';

    const ordered = JOURS_FULL.map(j => ({
        jour: j,
        nb: distribution[j] ? distribution[j].nb : 0,
        pct: distribution[j] ? distribution[j].pct : 0,
    }));
    const maxPct = Math.max(...ordered.map(d => d.pct), 1);

    for (let i = 0; i < ordered.length; i++) {
        const d = ordered[i];
        const heightPct = (d.pct / maxPct) * 100;
        const isSpike = d.pct > 20;
        const isQuiet = d.pct < 5;

        const wrap = document.createElement('div');
        wrap.className = 'dow-bar-wrap';
        wrap.innerHTML = `
            <div class="dow-pct">${d.pct.toFixed(1)}%</div>
            <div class="dow-bar ${isSpike ? 'spike' : isQuiet ? 'quiet' : ''}" style="height:${Math.max(heightPct, 3)}%"></div>
            <div class="dow-label">${JOURS[i]}<br><span style="color:var(--text);font-weight:700">${d.nb.toLocaleString('fr-CA')}</span></div>
        `;
        container.appendChild(wrap);
    }
}

async function loadPatterns(page) {
    const list = document.getElementById('patterns-list');
    list.innerHTML = '<div class="loading">Chargement des patterns...</div>';

    const params = new URLSearchParams();
    params.set('page', page);
    params.set('per_page', 20);
    const muni = document.getElementById('pat-inp-muni').value.trim();
    if (muni) params.set('municipality', muni);

    try {
        const r = await fetch(BASE + '/api/day-patterns?' + params);
        const d = await r.json();
        if (d.error) { list.innerHTML = `<div class="empty">Erreur: ${d.error}</div>`; return; }

        document.getElementById('tab-count-pat').textContent = d.total || 0;
        document.getElementById('pat-results-count').textContent = d.total + ' patterns anormaux';

        // Global distribution
        if (d.global_distribution && Object.keys(d.global_distribution).length > 0) {
            renderDowChart('global-dow-chart', d.global_distribution);
        }

        if (!d.patterns || d.patterns.length === 0) {
            list.innerHTML = '<div class="empty">Aucun pattern anormal detecte. Executez le detecteur jour_semaine d\'abord.</div>';
            return;
        }

        list.innerHTML = '';
        for (const p of d.patterns) {
            const card = document.createElement('div');
            card.className = 'pattern-card';

            // Mini chart for this municipality
            const chartId = 'dow-' + p.id;
            let distHTML = '';
            if (p.distribution && Object.keys(p.distribution).length > 0) {
                distHTML = `<div class="dow-chart" id="${chartId}" style="height:120px;"></div>`;
            }

            card.innerHTML = `
                <div class="anom-head">
                    <div class="pc-title">${p.nom_municipalite || p.lieu}${p.region_admin ? ' <span style="color:var(--dim);font-size:.75rem">('+p.region_admin+')</span>' : ''}</div>
                    <div class="anom-meta">
                        <span class="badge ${p.severity}">${p.severity}</span>
                        <span class="badge ${p.pattern_type === 'spike' ? 'high' : 'low'}">${p.pattern_type === 'spike' ? 'Pic' : 'Creux'}: ${p.jour_pic || '?'}</span>
                    </div>
                </div>
                <div style="display:flex;gap:1.5rem;margin:.5rem 0;font-size:.85rem;">
                    <span>Jour pic: <strong style="color:var(--accent)">${p.jour_pic || '—'}</strong></span>
                    <span>% observe: <strong style="color:${p.pct_jour_pic > 20 ? 'var(--red)' : 'var(--text)'}">${p.pct_jour_pic.toFixed(1)}%</strong></span>
                    <span>% attendu: <strong>${p.pct_attendu.toFixed(1)}%</strong></span>
                    <span>Z-score: <strong style="color:var(--orange)">${p.z_score.toFixed(1)}</strong></span>
                    <span>Total constats: <strong>${p.total_constats ? p.total_constats.toLocaleString('fr-CA') : '—'}</strong></span>
                </div>
                ${distHTML}
                <div class="anom-defense">${p.defense_text || ''}</div>
            `;
            list.appendChild(card);

            // Render mini chart after DOM insertion
            if (p.distribution && Object.keys(p.distribution).length > 0) {
                setTimeout(() => {
                    const el = document.getElementById(chartId);
                    if (!el) return;
                    el.innerHTML = '';
                    const dist = p.distribution;
                    const vals = JOURS_FULL.map(j => ({
                        jour: j,
                        nb: dist[j] ? dist[j].nb : 0,
                        pct: dist[j] ? dist[j].pct : 0,
                        z: dist[j] ? dist[j].z : 0,
                    }));
                    const maxP = Math.max(...vals.map(v => v.pct), 1);
                    for (let i = 0; i < vals.length; i++) {
                        const v = vals[i];
                        const h = (v.pct / maxP) * 100;
                        const cls = v.z > 2.5 ? 'spike' : v.z < -2.5 ? 'quiet' : '';
                        const w = document.createElement('div');
                        w.className = 'dow-bar-wrap';
                        w.innerHTML = `
                            <div class="dow-pct">${v.pct.toFixed(1)}%</div>
                            <div class="dow-bar ${cls}" style="height:${Math.max(h,3)}%"></div>
                            <div class="dow-label">${JOURS[i]}</div>
                        `;
                        el.appendChild(w);
                    }
                }, 10);
            }
        }

        renderPagination('pat-pagination', d.page, d.total_pages, loadPatterns);

    } catch(e) {
        list.innerHTML = `<div class="empty">Erreur: ${e.message}</div>`;
    }
}

// ═══ OCR STATS ═══
async function loadOCR() {
    const content = document.getElementById('ocr-content');
    content.innerHTML = '<div class="loading">Chargement...</div>';

    try {
        const r = await fetch(BASE + '/api/ocr-stats');
        const d = await r.json();

        document.getElementById('ocr-total').textContent = d.total_scans || 0;
        document.getElementById('tab-count-ocr').textContent = d.total_scans || 0;

        if (d.total_scans === 0) {
            document.getElementById('ocr-matricules').textContent = '0';
            document.getElementById('ocr-rues').textContent = '0';
            content.innerHTML = `
                <div class="pattern-card">
                    <div class="pc-title">En attente de donnees</div>
                    <div class="pc-info">
                        ${d.message || 'Aucun ticket scanne encore.'}<br><br>
                        <strong>Comment ca fonctionne:</strong><br>
                        1. Un client scanne son ticket via le formulaire<br>
                        2. Le OCR (Mindee) extrait les champs: matricule, rue, appareil, etc.<br>
                        3. Les donnees s'accumulent dans <code>tickets_scannes_meta</code><br>
                        4. Apres 100+ scans, on voit emerger les patterns: quel policier donne le plus, quelles rues sont ciblees, etc.
                    </div>
                </div>
            `;
            return;
        }

        document.getElementById('ocr-matricules').textContent = d.top_matricules ? d.top_matricules.length : 0;
        document.getElementById('ocr-rues').textContent = d.top_rues ? d.top_rues.length : 0;

        let html = '';
        if (d.top_matricules && d.top_matricules.length > 0) {
            html += '<div class="stitle">Top matricules policiers</div>';
            for (const m of d.top_matricules) {
                html += `<div class="pattern-card"><strong>${m.matricule}</strong> (${m.corps || '?'}) — <span style="color:var(--red);font-weight:800">${m.nb_tickets} tickets</span></div>`;
            }
        }
        if (d.top_rues && d.top_rues.length > 0) {
            html += '<div class="stitle">Top rues ciblees</div>';
            for (const rue of d.top_rues) {
                html += `<div class="pattern-card"><strong>${rue.rue}</strong> (${rue.ville || '?'}) — <span style="color:var(--orange);font-weight:800">${rue.nb_tickets} tickets</span></div>`;
            }
        }
        if (d.top_corps && d.top_corps.length > 0) {
            html += '<div class="stitle">Par corps policier</div>';
            for (const c of d.top_corps) {
                html += `<div class="pattern-card"><strong>${c.corps}</strong> — ${c.nb_tickets} tickets</div>`;
            }
        }
        content.innerHTML = html || '<div class="empty">Donnees en cours d\'accumulation...</div>';

    } catch(e) {
        content.innerHTML = `<div class="empty">Erreur: ${e.message}</div>`;
    }
}

// ═══ PAGINATION HELPER ═══
function renderPagination(containerId, currentPage, totalPages, loadFn) {
    const pag = document.getElementById(containerId);
    pag.innerHTML = '';
    if (totalPages <= 1) return;
    for (let p = 1; p <= Math.min(totalPages, 10); p++) {
        const btn = document.createElement('button');
        btn.textContent = p;
        if (p === currentPage) btn.className = 'active';
        btn.onclick = () => loadFn(p);
        pag.appendChild(btn);
    }
    if (totalPages > 10) {
        const sp = document.createElement('span');
        sp.textContent = `... ${totalPages}`;
        sp.style.cssText = 'color:var(--muted);padding:.4rem';
        pag.appendChild(sp);
    }
}

// ═══ INIT ═══
loadSummary();
loadDetails(1);
tabsLoaded.anomalies = true;

// Navbar scroll effect
window.addEventListener('scroll',()=>{
    const nav=document.querySelector('.navbar');
    if(window.scrollY>50) nav.classList.add('scrolled');
    else nav.classList.remove('scrolled');
});
</script>

</body>
</html>
