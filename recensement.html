<!DOCTYPE html>
<html lang="fr" data-theme="light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Recensement des Stats — Anomalies Quebec</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
/* ===== CSS VARIABLES ===== */
:root {
  --bg:#f0f4f8;--card:#ffffff;--card-alt:#f8fafc;--accent:#1e3a5f;--accent-light:#2a4f7f;
  --red:#e63946;--gold:#d4a843;--green:#16a34a;--yellow:#ca8a04;--orange:#ea580c;
  --purple:#7c3aed;--cyan:#0891b2;--pink:#db2777;
  --text:#1e293b;--text2:#334155;--dim:#64748b;--muted:#94a3b8;
  --border:#e2e8f0;--border-light:#f1f5f9;
  --shadow:0 1px 3px rgba(0,0,0,.06),0 2px 8px rgba(0,0,0,.04);
  --shadow-lg:0 8px 24px rgba(0,0,0,.08);
  --sidebar-w:240px;--topbar-h:56px;
}
[data-theme="dark"] {
  --bg:#0b1120;--card:#1e293b;--card-alt:#162032;
  --text:#e2e8f0;--text2:#cbd5e1;--dim:#94a3b8;--muted:#64748b;
  --border:#334155;--border-light:#1e293b;
  --shadow:0 1px 3px rgba(0,0,0,.3),0 2px 8px rgba(0,0,0,.2);
  --shadow-lg:0 8px 24px rgba(0,0,0,.3);
}

/* ===== RESET ===== */
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Inter',system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;transition:background .3s,color .3s;}
a{text-decoration:none;color:inherit;}
::-webkit-scrollbar{width:6px;}::-webkit-scrollbar-track{background:var(--border-light);}
::-webkit-scrollbar-thumb{background:var(--muted);border-radius:3px;}::-webkit-scrollbar-thumb:hover{background:var(--dim);}

/* ===== SIDEBAR ===== */
.sidebar{position:fixed;top:0;left:0;bottom:0;width:var(--sidebar-w);background:#0f172a;z-index:200;display:flex;flex-direction:column;transition:transform .3s ease;overflow-y:auto;overflow-x:hidden;}
.sidebar-logo{padding:20px 20px 16px;border-bottom:1px solid rgba(255,255,255,.08);}
.sidebar-logo h1{font-size:18px;font-weight:900;color:#fff;letter-spacing:-.5px;}
.sidebar-logo h1 em{color:var(--gold);font-style:normal;}
.sidebar-logo .sub{font-size:10px;color:rgba(255,255,255,.4);font-weight:500;letter-spacing:1px;text-transform:uppercase;margin-top:2px;}
.sidebar-nav{padding:12px 0;flex:1;}
.sidebar-group-label{font-size:9px;font-weight:700;color:rgba(255,255,255,.3);text-transform:uppercase;letter-spacing:1.5px;padding:16px 20px 6px;}
.sidebar-link{display:flex;align-items:center;gap:10px;padding:10px 20px;font-size:13px;font-weight:500;color:rgba(255,255,255,.55);transition:all .15s;cursor:pointer;border-left:3px solid transparent;}
.sidebar-link:hover{color:#fff;background:rgba(255,255,255,.05);}
.sidebar-link.active{color:var(--gold);background:rgba(212,168,67,.08);border-left-color:var(--gold);}
.sidebar-link svg{width:18px;height:18px;opacity:.6;flex-shrink:0;}.sidebar-link.active svg{opacity:1;}
.sidebar-divider{height:1px;background:rgba(255,255,255,.06);margin:8px 16px;}
.sidebar-footer{padding:16px 20px;border-top:1px solid rgba(255,255,255,.08);}
.sidebar-status{display:flex;align-items:center;gap:8px;font-size:11px;color:rgba(255,255,255,.5);margin-bottom:12px;}
.dot{width:8px;height:8px;border-radius:50%;background:var(--green);animation:pulse 2s infinite;flex-shrink:0;}
@keyframes pulse{0%,100%{opacity:1;box-shadow:0 0 6px rgba(74,222,128,.4)}50%{opacity:.4;box-shadow:0 0 2px rgba(74,222,128,.1)}}
.theme-toggle{display:flex;align-items:center;gap:8px;font-size:11px;color:rgba(255,255,255,.5);cursor:pointer;padding:6px 0;transition:color .15s;}
.theme-toggle:hover{color:rgba(255,255,255,.8);}
.theme-toggle-track{width:36px;height:20px;background:rgba(255,255,255,.15);border-radius:10px;position:relative;transition:background .2s;}
.theme-toggle-thumb{width:16px;height:16px;background:#fff;border-radius:50%;position:absolute;top:2px;left:2px;transition:transform .2s;}
[data-theme="dark"] .theme-toggle-thumb{transform:translateX(16px);}
[data-theme="dark"] .theme-toggle-track{background:var(--gold);}

/* ===== HAMBURGER ===== */
.hamburger{display:none;position:fixed;top:10px;left:10px;z-index:300;width:40px;height:40px;background:#0f172a;border:none;border-radius:10px;cursor:pointer;flex-direction:column;align-items:center;justify-content:center;gap:4px;box-shadow:0 2px 8px rgba(0,0,0,.2);}
.hamburger span{width:18px;height:2px;background:#fff;border-radius:1px;transition:all .2s;}
.sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:190;}

/* ===== MAIN CONTENT ===== */
.main-content{margin-left:var(--sidebar-w);min-height:100vh;transition:margin-left .3s;}

/* ===== TOP BAR ===== */
.top-bar{height:var(--topbar-h);background:var(--card);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 28px;position:sticky;top:0;z-index:100;transition:background .3s,border-color .3s;}
.top-bar-left{display:flex;align-items:center;gap:12px;}
.top-bar-title{font-size:15px;font-weight:700;color:var(--text);}
.live-badge{display:inline-flex;align-items:center;gap:5px;background:rgba(22,163,74,.1);color:var(--green);padding:3px 10px;border-radius:20px;font-size:10px;font-weight:700;letter-spacing:.5px;}
.live-badge::before{content:'';width:6px;height:6px;background:var(--green);border-radius:50%;animation:pulse 2s infinite;}

/* ===== HERO KPIS ===== */
.hero-kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;padding:24px 28px 8px;max-width:1400px;}
.kpi-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:22px;box-shadow:var(--shadow);transition:all .25s;position:relative;overflow:hidden;text-align:center;}
.kpi-card:hover{box-shadow:var(--shadow-lg);transform:translateY(-2px);}
.kpi-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;border-radius:14px 14px 0 0;}
.kpi-total::before{background:var(--accent);}.kpi-high::before{background:var(--red);}
.kpi-med::before{background:var(--orange);}.kpi-low::before{background:var(--green);}
.kpi-value{font-size:32px;font-weight:900;line-height:1;letter-spacing:-1px;margin-bottom:4px;}
.kpi-total .kpi-value{color:var(--accent);}.kpi-high .kpi-value{color:var(--red);}
.kpi-med .kpi-value{color:var(--orange);}.kpi-low .kpi-value{color:var(--green);}
.kpi-label{font-size:11px;color:var(--dim);text-transform:uppercase;letter-spacing:.5px;font-weight:600;}

/* ===== CONTENT AREA ===== */
.content-area{padding:16px 28px 40px;max-width:1400px;}

/* DB stats row */
.db-row{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px;}
.db-mini{background:var(--card);border-radius:10px;padding:12px 16px;border:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;box-shadow:var(--shadow);}
.db-mini .db-label{color:var(--dim);font-size:12px;font-weight:500;}
.db-mini .db-val{color:var(--cyan);font-weight:700;font-size:14px;}

/* ===== TABS ===== */
.tabs-bar{display:flex;gap:0;margin-bottom:20px;border-bottom:2px solid var(--border);background:var(--card);border-radius:12px 12px 0 0;overflow-x:auto;}
.tab-btn{padding:12px 20px;border:none;background:none;color:var(--dim);font-family:inherit;font-size:13px;font-weight:700;cursor:pointer;border-bottom:3px solid transparent;margin-bottom:-2px;transition:all .2s;white-space:nowrap;}
.tab-btn:hover{color:var(--text);background:var(--card-alt);}
.tab-btn.active{color:var(--accent);border-bottom-color:var(--accent);}
.tab-btn .tab-count{display:inline-block;background:var(--border-light);padding:1px 7px;border-radius:10px;font-size:10px;margin-left:4px;color:var(--dim);}
.tab-btn.active .tab-count{background:rgba(30,58,95,.1);color:var(--accent);}
[data-theme="dark"] .tab-btn.active .tab-count{background:rgba(212,168,67,.15);color:var(--gold);}
.tab-panel{display:none;}.tab-panel.active{display:block;}

/* ===== SECTION TITLES ===== */
.stitle{font-size:14px;font-weight:700;margin:24px 0 10px;color:var(--text);display:flex;align-items:center;gap:8px;}
.stitle::before{content:'';width:4px;height:18px;background:var(--accent);border-radius:2px;}
.stitle .count-tag{font-size:10px;background:var(--card-alt);padding:2px 8px;border-radius:10px;color:var(--dim);margin-left:4px;border:1px solid var(--border);}

/* ===== TYPE CHIPS ===== */
.types-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px;margin-bottom:20px;}
.type-chip{background:var(--card);border-radius:8px;padding:10px 14px;display:flex;justify-content:space-between;align-items:center;border:1px solid var(--border);font-size:12px;cursor:pointer;transition:all .2s;box-shadow:var(--shadow);}
.type-chip:hover{border-color:var(--accent);box-shadow:var(--shadow-lg);}
.type-chip.active{border-color:var(--accent);background:rgba(30,58,95,.05);}
[data-theme="dark"] .type-chip.active{background:rgba(30,58,95,.3);}
.type-chip .count{font-weight:800;color:var(--accent);font-size:14px;}

/* ===== SEARCH BOX ===== */
.search-box{background:var(--card);border-radius:12px;padding:16px 20px;border:1px solid var(--border);margin-bottom:20px;box-shadow:var(--shadow);}
.search-box h3{font-size:13px;margin-bottom:10px;color:var(--text);font-weight:700;}
.search-row{display:flex;gap:8px;flex-wrap:wrap;}
.search-row input,.search-row select{flex:1;min-width:120px;padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:var(--card-alt);color:var(--text);font-family:inherit;font-size:13px;outline:none;transition:border .2s;}
.search-row input:focus{border-color:var(--accent);}
.search-row select{min-width:140px;}
.search-row input::placeholder{color:var(--muted);}
.search-row button{padding:8px 20px;border-radius:8px;border:none;background:var(--accent);color:white;font-weight:700;cursor:pointer;font-family:inherit;font-size:13px;white-space:nowrap;transition:all .2s;}
.search-row button:hover{background:var(--accent-light);}
.btn-reset{background:var(--dim)!important;}
.btn-reset:hover{background:var(--muted)!important;}

/* ===== ANOMALY CARDS ===== */
.anomaly-list{display:flex;flex-direction:column;gap:10px;}
.anom-card{background:var(--card);border-radius:10px;padding:16px 18px;border:1px solid var(--border);border-left:4px solid var(--accent);transition:all .2s;box-shadow:var(--shadow);}
.anom-card:hover{box-shadow:var(--shadow-lg);}
.anom-card.high{border-left-color:var(--red);}
.anom-card.medium{border-left-color:var(--orange);}
.anom-card.low{border-left-color:var(--green);}
.anom-head{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;gap:12px;flex-wrap:wrap;}
.anom-title{font-weight:700;font-size:13px;color:var(--text);}
.anom-meta{display:flex;gap:6px;flex-wrap:wrap;}
.badge{display:inline-block;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.3px;}
.badge.high{background:rgba(230,57,70,.12);color:var(--red);}
.badge.medium{background:rgba(234,88,12,.12);color:var(--orange);}
.badge.low{background:rgba(22,163,74,.12);color:var(--green);}
.badge.conf{background:rgba(30,58,95,.08);color:var(--accent);}
.anom-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:6px;margin:8px 0;padding:8px 0;border-top:1px solid var(--border-light);border-bottom:1px solid var(--border-light);}
.anom-stat{text-align:center;}
.anom-stat .val{font-weight:800;font-size:14px;font-family:'Courier New',monospace;}
.anom-stat .lbl{font-size:10px;color:var(--muted);text-transform:uppercase;}
.anom-stat .val.red{color:var(--red);}.anom-stat .val.orange{color:var(--orange);}
.anom-stat .val.green{color:var(--green);}.anom-stat .val.blue{color:var(--accent);}
.anom-defense{color:var(--dim);font-size:12px;line-height:1.5;margin:6px 0;}
.anom-ref{color:var(--muted);font-size:11px;font-style:italic;}
.anom-constats{margin-top:8px;padding:10px 12px;background:var(--card-alt);border-radius:8px;font-size:12px;color:var(--dim);border:1px solid var(--border);}
.anom-constats .ci-title{color:var(--cyan);font-weight:700;margin-bottom:4px;font-size:12px;}
.anom-constats .ci-row{display:flex;gap:16px;flex-wrap:wrap;}
.anom-constats .ci-val{color:var(--text);font-weight:600;}

/* ===== BLITZ CARDS ===== */
.blitz-card{background:var(--card);border-radius:10px;padding:16px 18px;border:1px solid var(--border);border-left:4px solid var(--red);margin-bottom:10px;transition:all .2s;box-shadow:var(--shadow);}
.blitz-card:hover{box-shadow:var(--shadow-lg);}
.blitz-card.medium{border-left-color:var(--orange);}
.blitz-card.low{border-left-color:var(--green);}
.blitz-head{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;}
.blitz-title{font-weight:800;font-size:14px;color:var(--text);}
.blitz-date{color:var(--cyan);font-size:12px;font-weight:600;}
.blitz-metrics{display:flex;gap:20px;margin:8px 0;flex-wrap:wrap;}
.blitz-metric{text-align:center;}
.blitz-metric .bm-val{font-weight:900;font-size:16px;font-family:'Courier New',monospace;}
.blitz-metric .bm-val.red{color:var(--red);}.blitz-metric .bm-val.orange{color:var(--orange);}
.blitz-metric .bm-val.blue{color:var(--accent);}
.blitz-metric .bm-lbl{font-size:10px;color:var(--muted);text-transform:uppercase;}

/* ===== DAY PATTERN CHART ===== */
.dow-chart{display:flex;gap:4px;align-items:flex-end;height:160px;margin:12px 0;}
.dow-bar-wrap{flex:1;display:flex;flex-direction:column;align-items:center;height:100%;justify-content:flex-end;}
.dow-bar{width:100%;border-radius:4px 4px 0 0;min-height:4px;background:var(--accent);transition:height .5s ease;}
.dow-bar.spike{background:var(--red);}.dow-bar.quiet{background:var(--green);}
.dow-label{font-size:10px;color:var(--dim);margin-top:4px;text-align:center;}
.dow-pct{font-size:11px;font-weight:700;color:var(--text);margin-bottom:3px;}

/* ===== PATTERN CARD ===== */
.pattern-card{background:var(--card);border-radius:10px;padding:14px 16px;border:1px solid var(--border);margin-bottom:10px;box-shadow:var(--shadow);transition:all .2s;}
.pattern-card:hover{box-shadow:var(--shadow-lg);}
.pattern-card .pc-title{font-weight:700;font-size:13px;margin-bottom:6px;color:var(--text);}
.pattern-card .pc-info{color:var(--dim);font-size:12px;line-height:1.5;}

/* ===== PAGINATION ===== */
.pagination{display:flex;justify-content:center;gap:6px;margin:24px 0;}
.pagination button{padding:6px 12px;border-radius:6px;border:1px solid var(--border);background:var(--card);color:var(--text);cursor:pointer;font-family:inherit;font-size:12px;transition:all .2s;}
.pagination button.active{background:var(--accent);border-color:var(--accent);color:#fff;}
.pagination button:hover:not(.active){background:var(--card-alt);}

/* ===== MISC ===== */
.meta-footer{text-align:center;padding:24px 0;color:var(--muted);font-size:11px;border-top:1px solid var(--border);margin-top:24px;}
.loading{text-align:center;padding:40px;color:var(--dim);}
.empty{text-align:center;padding:24px;color:var(--muted);font-style:italic;}

/* ===== RESPONSIVE ===== */
@media(max-width:1200px){.hero-kpis{grid-template-columns:repeat(2,1fr);}}
@media(max-width:768px){
  .sidebar{transform:translateX(-100%);}.sidebar.open{transform:translateX(0);}
  .sidebar-overlay.active{display:block;}
  .hamburger{display:flex;}
  .main-content{margin-left:0;}
  .top-bar{padding:0 16px 0 56px;}
  .hero-kpis{grid-template-columns:repeat(2,1fr);gap:10px;padding:16px;}
  .content-area{padding:12px 16px 40px;}
  .db-row{grid-template-columns:1fr;}
  .search-row{flex-direction:column;}
  .anom-stats{grid-template-columns:repeat(3,1fr);}
  .kpi-value{font-size:24px;}
}
@media(max-width:480px){.hero-kpis{grid-template-columns:1fr;}}
</style>
</head>
<body>

<!-- Hamburger mobile -->
<button class="hamburger" onclick="toggleSidebar()"><span></span><span></span><span></span></button>
<div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

<!-- ===== SIDEBAR ===== -->
<aside class="sidebar" id="sidebar">
  <div class="sidebar-logo">
    <h1>AI<em>TicketInfo</em></h1>
    <div class="sub">Recensement</div>
  </div>
  <nav class="sidebar-nav">
    <div class="sidebar-group-label">Sections</div>
    <a class="sidebar-link active" onclick="sidebarTab('anomalies')" data-tab="anomalies">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
      Anomalies
    </a>
    <a class="sidebar-link" onclick="sidebarTab('blitz')" data-tab="blitz">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
      Blitz
    </a>
    <a class="sidebar-link" onclick="sidebarTab('patterns')" data-tab="patterns">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
      Patterns
    </a>
    <a class="sidebar-link" onclick="sidebarTab('ocr')" data-tab="ocr">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
      Tickets scannes
    </a>
    <div class="sidebar-divider"></div>
    <div class="sidebar-group-label">Liens externes</div>
    <a class="sidebar-link" href="/scanticket/">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/></svg>
      Scanner
    </a>
    <a class="sidebar-link" href="/scanticket/admin">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
      Admin
    </a>
    <a class="sidebar-link" href="/scanticket/chatbot">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
      Chatbot
    </a>
    <a class="sidebar-link" href="/scanticket/presentation">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
      Presentation
    </a>
  </nav>
  <div class="sidebar-footer">
    <div class="sidebar-status">
      <div class="dot"></div>
      <span>Donnees reelles</span>
    </div>
    <div class="theme-toggle" onclick="toggleDarkMode()">
      <div class="theme-toggle-track"><div class="theme-toggle-thumb"></div></div>
      <span id="themeLabel">Mode sombre</span>
    </div>
  </div>
</aside>

<!-- ===== MAIN CONTENT ===== -->
<main class="main-content">
  <header class="top-bar">
    <div class="top-bar-left">
      <span class="top-bar-title">Recensement des Stats</span>
      <span class="live-badge">LIVE — DONNEES REELLES</span>
    </div>
    <div class="top-bar-right" style="font-size:11px;color:var(--dim)">Detection d'anomalies — Contraventions Quebec</div>
  </header>

  <!-- Hero KPIs -->
  <section class="hero-kpis">
    <div class="kpi-card kpi-total"><div class="kpi-value" id="s-total">—</div><div class="kpi-label">Anomalies actives</div></div>
    <div class="kpi-card kpi-high"><div class="kpi-value" id="s-high">—</div><div class="kpi-label">Critiques</div></div>
    <div class="kpi-card kpi-med"><div class="kpi-value" id="s-med">—</div><div class="kpi-label">Moyennes</div></div>
    <div class="kpi-card kpi-low"><div class="kpi-value" id="s-low">—</div><div class="kpi-label">Faibles</div></div>
  </section>

  <div class="content-area">
    <!-- DB stats -->
    <div class="db-row">
      <div class="db-mini"><span class="db-label">Constats analyses</span><span class="db-val" id="db-constats">—</span></div>
      <div class="db-mini"><span class="db-label">Jurisprudence tickets</span><span class="db-val" id="db-juris">—</span></div>
      <div class="db-mini"><span class="db-label">Radars actifs</span><span class="db-val" id="db-radars">—</span></div>
    </div>

    <!-- Tabs -->
    <div class="tabs-bar">
      <button class="tab-btn active" onclick="switchTab('anomalies')">Anomalies <span class="tab-count" id="tab-count-anom">—</span></button>
      <button class="tab-btn" onclick="switchTab('blitz')">Blitz <span class="tab-count" id="tab-count-blitz">—</span></button>
      <button class="tab-btn" onclick="switchTab('patterns')">Patterns <span class="tab-count" id="tab-count-pat">—</span></button>
      <button class="tab-btn" onclick="switchTab('ocr')">Tickets scannes <span class="tab-count" id="tab-count-ocr">—</span></button>
    </div>

    <!-- TAB: ANOMALIES -->
    <div class="tab-panel active" id="panel-anomalies">
      <div class="stitle">Anomalies par type <span class="count-tag" id="type-count"></span></div>
      <div class="types-grid" id="types-grid"></div>
      <div class="search-box">
        <h3>Filtrer les anomalies</h3>
        <div class="search-row">
          <input type="text" id="inp-lieu" placeholder="Ville ou code (ex: Quebec, 66023)">
          <input type="text" id="inp-article" placeholder="Article (ex: 463)">
          <select id="sel-severity"><option value="">Toutes severites</option><option value="high">Critiques</option><option value="medium">Moyennes</option><option value="low">Faibles</option></select>
          <select id="sel-type"><option value="">Tous les types</option></select>
          <button onclick="loadDetails(1)">Filtrer</button>
          <button class="btn-reset" onclick="resetFilters()">Reset</button>
        </div>
      </div>
      <div class="stitle">Anomalies detectees <span class="count-tag" id="results-count"></span></div>
      <div class="anomaly-list" id="anomaly-list"><div class="loading">Chargement...</div></div>
      <div class="pagination" id="pagination"></div>
    </div>

    <!-- TAB: BLITZ -->
    <div class="tab-panel" id="panel-blitz">
      <div class="stitle">Operations blitz detectees <span class="count-tag" id="blitz-results-count"></span></div>
      <p style="color:var(--dim);font-size:12px;margin-bottom:12px">Jours ou une municipalite a eu un pic massif de constats (30+ par jour, 3x+ la moyenne). Indicatif d'operations policieres ciblees.</p>
      <div class="hero-kpis" style="padding:0;margin-bottom:16px">
        <div class="kpi-card kpi-high"><div class="kpi-value" id="blitz-high">—</div><div class="kpi-label">Blitz critiques</div></div>
        <div class="kpi-card kpi-med"><div class="kpi-value" id="blitz-med">—</div><div class="kpi-label">Blitz moyens</div></div>
        <div class="kpi-card kpi-low"><div class="kpi-value" id="blitz-low">—</div><div class="kpi-label">Blitz faibles</div></div>
        <div class="kpi-card kpi-total"><div class="kpi-value" id="blitz-max">—</div><div class="kpi-label">Max constats/jour</div></div>
      </div>
      <div class="search-box">
        <div class="search-row">
          <input type="text" id="blitz-inp-muni" placeholder="Municipalite (ex: Montreal)">
          <select id="blitz-sel-sev"><option value="">Toutes severites</option><option value="high">Critiques</option><option value="medium">Moyens</option><option value="low">Faibles</option></select>
          <button onclick="loadBlitz(1)">Filtrer</button>
          <button class="btn-reset" onclick="document.getElementById('blitz-inp-muni').value='';document.getElementById('blitz-sel-sev').value='';loadBlitz(1);">Reset</button>
        </div>
      </div>
      <div id="blitz-list"><div class="loading">Cliquez sur l'onglet pour charger...</div></div>
      <div class="pagination" id="blitz-pagination"></div>
    </div>

    <!-- TAB: PATTERNS -->
    <div class="tab-panel" id="panel-patterns">
      <div class="stitle">Patterns jour de semaine <span class="count-tag" id="pat-results-count"></span></div>
      <p style="color:var(--dim);font-size:12px;margin-bottom:12px">Distribution des constats par jour de semaine. Identifie les municipalites ou certains jours concentrent anormalement plus de tickets (z-score &ge; 2.5).</p>
      <div class="pattern-card">
        <div class="pc-title">Distribution provinciale (toutes municipalites)</div>
        <div class="dow-chart" id="global-dow-chart"></div>
      </div>
      <div class="search-box" style="margin-top:12px">
        <div class="search-row">
          <input type="text" id="pat-inp-muni" placeholder="Municipalite (ex: Laval)">
          <button onclick="loadPatterns(1)">Filtrer</button>
          <button class="btn-reset" onclick="document.getElementById('pat-inp-muni').value='';loadPatterns(1);">Reset</button>
        </div>
      </div>
      <div id="patterns-list"><div class="loading">Cliquez sur l'onglet pour charger...</div></div>
      <div class="pagination" id="pat-pagination"></div>
    </div>

    <!-- TAB: OCR -->
    <div class="tab-panel" id="panel-ocr">
      <div class="stitle">Donnees des tickets scannes (OCR)</div>
      <p style="color:var(--dim);font-size:12px;margin-bottom:12px">Au fur et a mesure que les clients scannent leurs tickets, on accumule les donnees: matricule policier, rue exacte, corps de police, appareil de mesure, etc. Ces donnees ne sont PAS dans les fichiers publics du Quebec.</p>
      <div class="hero-kpis" style="padding:0;margin-bottom:16px;grid-template-columns:repeat(3,1fr)">
        <div class="kpi-card kpi-total"><div class="kpi-value" id="ocr-total">—</div><div class="kpi-label">Tickets scannes</div></div>
        <div class="kpi-card kpi-high"><div class="kpi-value" id="ocr-matricules">—</div><div class="kpi-label">Matricules uniques</div></div>
        <div class="kpi-card kpi-med"><div class="kpi-value" id="ocr-rues">—</div><div class="kpi-label">Rues indexees</div></div>
      </div>
      <div id="ocr-content"><div class="loading">Cliquez sur l'onglet pour charger...</div></div>
    </div>

    <div class="meta-footer" id="meta-footer"></div>
  </div>
</main>

<script>
/* ===== THEME ===== */
function toggleDarkMode(){
  const isDark=document.documentElement.getAttribute('data-theme')==='dark';
  document.documentElement.setAttribute('data-theme',isDark?'light':'dark');
  localStorage.setItem('ati-theme',isDark?'light':'dark');
  document.getElementById('themeLabel').textContent=isDark?'Mode sombre':'Mode clair';
}
(function(){
  const t=localStorage.getItem('ati-theme')||'light';
  document.documentElement.setAttribute('data-theme',t);
  const lbl=document.getElementById('themeLabel');
  if(lbl) lbl.textContent=t==='dark'?'Mode clair':'Mode sombre';
})();

/* ===== SIDEBAR ===== */
function toggleSidebar(){
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('sidebarOverlay').classList.toggle('active');
}
function sidebarTab(name){
  switchTab(name);
  document.querySelectorAll('.sidebar-link[data-tab]').forEach(l=>l.classList.remove('active'));
  const link=document.querySelector(`.sidebar-link[data-tab="${name}"]`);
  if(link) link.classList.add('active');
  if(window.innerWidth<=768) toggleSidebar();
}

/* ===== DATA ===== */
const BASE=window.location.pathname.replace(/\/recensement\.html.*/,'').replace(/\/recensement$/,'');
const API=BASE+'/api/recensement';

const TYPE_LABELS={
  'anomalie_saisonniere':'Anomalie saisonniere','article_surrepresente':'Article surrepresente',
  'hotspot_geo':'Hotspot geographique','spike_fin_mois':'Quota fin de mois',
  'taux_acquittement':'Taux acquittement','radar_disproportionne':'Radar disproportionne',
  'piege_vitesse':'Piege a vitesse','pattern_jour':'Pattern jour semaine',
  'vehicule_lourd_anomal':'Vehicule lourd cible','intervention_anomale':'Intervention anomale',
  'concentration_articles':'Concentration article','tendance_annuelle':'Tendance annuelle',
  'heure_pointe_anomale':'Heure de pointe','amende_disproportionnee':'Amende disproportionnee',
  'collision_vs_enforcement':'Constats vs accidents','tolerance_radar':'Tolerance radar',
  'points_anormaux':'Points inaptitude','spike_debut_mois':'Objectif debut mois',
  'exces_distribution':'Distribution exces','multi_infraction':'Multi-infraction',
  'recidive_municipale':'Recidive municipale','weekend_ratio':'Ratio week-end',
  'loi_anomale':'Loi anomale','vitesse_benford':'Benford vitesse',
  'bracketing_vitesse':'Bracketing seuils','blitz_vacances':'Blitz vacances',
  'zone_scolaire_hors_heures':'Zone scolaire','profilage_veil_darkness':'Profilage racial',
  'blitz_daily':'Blitz quotidien','pattern_jour_semaine':'Pattern jour semaine',
};
const TYPE_ICONS={
  'anomalie_saisonniere':'&#9670;','article_surrepresente':'&#9733;','hotspot_geo':'&#9679;',
  'spike_fin_mois':'&#9650;','taux_acquittement':'&#9745;','radar_disproportionne':'&#9673;',
  'piege_vitesse':'&#9889;','pattern_jour':'&#9683;','vehicule_lourd_anomal':'&#128666;',
  'intervention_anomale':'&#128270;','concentration_articles':'&#127919;','tendance_annuelle':'&#128200;',
  'heure_pointe_anomale':'&#9200;','amende_disproportionnee':'&#128176;','collision_vs_enforcement':'&#128680;',
  'tolerance_radar':'&#128207;','points_anormaux':'&#128293;','spike_debut_mois':'&#128197;',
  'exces_distribution':'&#128202;','multi_infraction':'&#128279;','recidive_municipale':'&#128257;',
  'weekend_ratio':'&#127774;','loi_anomale':'&#9878;','vitesse_benford':'&#128290;',
  'bracketing_vitesse':'&#128207;','blitz_vacances':'&#127958;','zone_scolaire_hors_heures':'&#127979;',
  'profilage_veil_darkness':'&#128101;','blitz_daily':'&#128680;','pattern_jour_semaine':'&#128197;',
};

let currentTypeFilter='';

async function loadSummary(){
  try{
    const r=await fetch(API);const d=await r.json();
    document.getElementById('s-total').textContent=(d.total_anomalies||0).toLocaleString('fr-CA');
    document.getElementById('s-high').textContent=(d.high||0).toLocaleString('fr-CA');
    document.getElementById('s-med').textContent=(d.medium||0).toLocaleString('fr-CA');
    document.getElementById('s-low').textContent=(d.low||0).toLocaleString('fr-CA');
    const tg=document.getElementById('types-grid');const sel=document.getElementById('sel-type');
    tg.innerHTML='';
    const types=Object.entries(d.by_type||{}).sort((a,b)=>b[1]-a[1]);
    document.getElementById('type-count').textContent=types.length+' types';
    document.getElementById('tab-count-anom').textContent=d.total_anomalies||0;
    for(const[type,count]of types){
      const chip=document.createElement('div');chip.className='type-chip';
      chip.innerHTML=`<span>${TYPE_LABELS[type]||type}</span><span class="count">${count}</span>`;
      chip.onclick=()=>{toggleType(type,chip);};tg.appendChild(chip);
      sel.innerHTML+=`<option value="${type}">${TYPE_LABELS[type]||type}</option>`;
    }
    document.getElementById('meta-footer').innerHTML=
      `Dernier calcul: ${d.last_computed?new Date(d.last_computed).toLocaleString('fr-CA'):'—'} | `+
      `Batch: ${d.last_batch||'—'} | Duree: ${d.last_duration_s||'—'}s | `+
      `Donnees: constats CRQ, radars QC, jurisprudence CanLII+SOQUIJ`;
  }catch(e){console.error(e);}
}

function toggleType(type,chip){
  document.querySelectorAll('.type-chip').forEach(c=>c.classList.remove('active'));
  if(currentTypeFilter===type){currentTypeFilter='';document.getElementById('sel-type').value='';}
  else{currentTypeFilter=type;chip.classList.add('active');document.getElementById('sel-type').value=type;}
  loadDetails(1);
}

function resetFilters(){
  document.getElementById('inp-lieu').value='';document.getElementById('inp-article').value='';
  document.getElementById('sel-severity').value='';document.getElementById('sel-type').value='';
  currentTypeFilter='';document.querySelectorAll('.type-chip').forEach(c=>c.classList.remove('active'));
  loadDetails(1);
}

async function loadDetails(page){
  const list=document.getElementById('anomaly-list');
  list.innerHTML='<div class="loading">Chargement des anomalies...</div>';
  const params=new URLSearchParams();params.set('page',page);params.set('per_page',30);
  const sev=document.getElementById('sel-severity').value;
  const typ=document.getElementById('sel-type').value||currentTypeFilter;
  if(sev)params.set('severity',sev);if(typ)params.set('type',typ);
  const lieu=document.getElementById('inp-lieu').value.trim();
  const article=document.getElementById('inp-article').value.trim();
  let url=API+'/details?'+params;
  try{
    const r=await fetch(url);const d=await r.json();
    if(d.error){list.innerHTML=`<div class="empty">Erreur: ${d.error}</div>`;return;}
    if(d.db_stats){
      document.getElementById('db-constats').textContent=(d.db_stats.total_constats||0).toLocaleString('fr-CA');
      document.getElementById('db-juris').textContent=(d.db_stats.total_jurisprudence||0).toLocaleString('fr-CA');
      document.getElementById('db-radars').textContent=(d.db_stats.total_radars_actifs||0).toLocaleString('fr-CA');
    }
    document.getElementById('results-count').textContent=d.total+' resultats';
    if(!d.anomalies||d.anomalies.length===0){list.innerHTML='<div class="empty">Aucune anomalie trouvee.</div>';document.getElementById('pagination').innerHTML='';return;}
    let anomalies=d.anomalies;
    if(lieu)anomalies=anomalies.filter(a=>a.region===lieu);
    if(article)anomalies=anomalies.filter(a=>a.article===article);
    list.innerHTML='';
    for(const a of anomalies){
      const card=document.createElement('div');card.className=`anom-card ${a.severity}`;
      let statsHTML=`
        <div class="anom-stat"><div class="val ${a.z_score>=3.5?'red':a.z_score>=2.5?'orange':'blue'}">${a.z_score?a.z_score.toFixed(1):'—'}</div><div class="lbl">Z-Score</div></div>
        <div class="anom-stat"><div class="val">${a.deviation_pct?(a.deviation_pct>0?'+':'')+a.deviation_pct.toFixed(0)+'%':'—'}</div><div class="lbl">Deviation</div></div>
        <div class="anom-stat"><div class="val blue">${a.observed?a.observed.toLocaleString('fr-CA',{maximumFractionDigits:1}):'—'}</div><div class="lbl">Observe</div></div>
        <div class="anom-stat"><div class="val">${a.expected?a.expected.toLocaleString('fr-CA',{maximumFractionDigits:1}):'—'}</div><div class="lbl">Attendu</div></div>
        <div class="anom-stat"><div class="val">${a.sample_size?a.sample_size.toLocaleString('fr-CA'):'—'}</div><div class="lbl">Echantillon</div></div>`;
      if(a.period_start)statsHTML+=`<div class="anom-stat"><div class="val">${a.period_start}</div><div class="lbl">Periode</div></div>`;
      let constatsHTML='';
      if(a.constats_info){const ci=a.constats_info;constatsHTML=`
        <div class="anom-constats"><div class="ci-title">Donnees constats — ${a.nom_municipalite||'Lieu '+a.region}</div><div class="ci-row">
          <div class="ci-item">Total: <span class="ci-val">${ci.total_constats.toLocaleString('fr-CA')}</span></div>
          <div class="ci-item">Periode: <span class="ci-val">${ci.premiere_date||'?'} a ${ci.derniere_date||'?'}</span></div>
          <div class="ci-item">Articles distincts: <span class="ci-val">${ci.nb_articles_distincts}</span></div>
          <div class="ci-item">Loi: <span class="ci-val">${ci.loi_freq||'—'}</span></div>
          <div class="ci-item">Description: <span class="ci-val">${ci.description_freq||'—'}</span></div>
          <div class="ci-item">Type: <span class="ci-val">${ci.type_intervention_freq||'—'}</span></div>
          ${ci.amende_moyenne?`<div class="ci-item">Amende moy: <span class="ci-val">${ci.amende_moyenne}$</span></div>`:''}
          ${ci.points_moyens?`<div class="ci-item">Points moy: <span class="ci-val">${ci.points_moyens}</span></div>`:''}
          ${ci.nb_avec_vitesse?`<div class="ci-item">Avec vitesse: <span class="ci-val">${ci.nb_avec_vitesse.toLocaleString('fr-CA')}</span></div>`:''}
        </div></div>`;}
      let detailsHTML='';
      if(a.details&&typeof a.details==='object'){const keys=Object.keys(a.details).filter(k=>!['mean_ratio','std_ratio'].includes(k));
        if(keys.length>0){const items=keys.slice(0,8).map(k=>{let v=a.details[k];if(typeof v==='object')v=JSON.stringify(v).substring(0,60);if(typeof v==='number')v=v.toLocaleString('fr-CA',{maximumFractionDigits:2});return`<span style="margin-right:12px">${k}: <strong>${v}</strong></span>`;}).join('');
        detailsHTML=`<div style="font-size:10px;color:var(--muted);margin-top:4px;line-height:1.6">${items}</div>`;}}
      card.innerHTML=`
        <div class="anom-head">
          <div><div class="anom-title">${TYPE_ICONS[a.type]||''} ${TYPE_LABELS[a.type]||a.type}${a.region?' — '+(a.nom_municipalite||'Lieu '+a.region):''}${a.mrc?' (MRC: '+a.mrc+')':''}${a.article?' — Art. '+a.article:''}</div>
          ${a.nom_municipalite?'<div style="color:var(--dim);font-size:10px;margin-top:2px">Code: '+a.region+(a.region_admin?' | Region: '+a.region_admin:'')+(a.population?' | Pop: '+Number(a.population).toLocaleString('fr-CA'):'')+'</div>':''}</div>
          <div class="anom-meta"><span class="badge ${a.severity}">${a.severity}</span><span class="badge conf">${a.confidence||'?'}</span></div>
        </div>
        <div class="anom-stats">${statsHTML}</div>
        <div class="anom-defense">${a.defense_text||''}</div>
        <div class="anom-ref">${a.legal_ref||''}</div>
        ${detailsHTML}${constatsHTML}`;
      list.appendChild(card);
    }
    const pag=document.getElementById('pagination');pag.innerHTML='';
    if(d.total_pages>1){for(let p=1;p<=Math.min(d.total_pages,10);p++){const btn=document.createElement('button');btn.textContent=p;if(p===d.page)btn.className='active';btn.onclick=()=>loadDetails(p);pag.appendChild(btn);}
    if(d.total_pages>10){const sp=document.createElement('span');sp.textContent=`... ${d.total_pages}`;sp.style.cssText='color:var(--muted);padding:6px';pag.appendChild(sp);}}
  }catch(e){list.innerHTML=`<div class="empty">Erreur: ${e.message}</div>`;}
}

/* ===== TAB SYSTEM ===== */
let tabsLoaded={anomalies:false,blitz:false,patterns:false,ocr:false};
function switchTab(name){
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
  document.querySelector(`[onclick="switchTab('${name}')"]`).classList.add('active');
  document.getElementById('panel-'+name).classList.add('active');
  // Update sidebar
  document.querySelectorAll('.sidebar-link[data-tab]').forEach(l=>l.classList.remove('active'));
  const sl=document.querySelector(`.sidebar-link[data-tab="${name}"]`);if(sl)sl.classList.add('active');
  if(!tabsLoaded[name]){tabsLoaded[name]=true;
    if(name==='blitz')loadBlitz(1);else if(name==='patterns')loadPatterns(1);else if(name==='ocr')loadOCR();}
}

/* ===== BLITZ ===== */
async function loadBlitz(page){
  const list=document.getElementById('blitz-list');list.innerHTML='<div class="loading">Chargement des blitz...</div>';
  const params=new URLSearchParams();params.set('page',page);params.set('per_page',30);
  const muni=document.getElementById('blitz-inp-muni').value.trim();const sev=document.getElementById('blitz-sel-sev').value;
  if(muni)params.set('municipality',muni);if(sev)params.set('severity',sev);
  try{
    const r=await fetch(BASE+'/api/blitz?'+params);const d=await r.json();
    if(d.error){list.innerHTML=`<div class="empty">Erreur: ${d.error}</div>`;return;}
    document.getElementById('tab-count-blitz').textContent=d.total||0;
    document.getElementById('blitz-results-count').textContent=d.total+' blitz';
    if(d.stats){document.getElementById('blitz-high').textContent=d.stats.high||0;document.getElementById('blitz-med').textContent=d.stats.medium||0;document.getElementById('blitz-low').textContent=d.stats.low||0;document.getElementById('blitz-max').textContent=d.stats.max_constats?Math.round(d.stats.max_constats):'—';}
    if(!d.blitz_events||d.blitz_events.length===0){list.innerHTML='<div class="empty">Aucun blitz detecte.</div>';return;}
    list.innerHTML='';
    for(const b of d.blitz_events){
      const card=document.createElement('div');card.className=`blitz-card ${b.severity}`;
      const ratio=b.ratio||(b.avg_daily>0?(b.nb_constats/b.avg_daily).toFixed(1):'?');
      card.innerHTML=`
        <div class="blitz-head"><div><div class="blitz-title">${b.nom_municipalite||b.lieu}${b.mrc?' <span style="color:var(--dim);font-size:11px">(MRC: '+b.mrc+')</span>':''}</div><div class="blitz-date">${b.date||'—'} — ${b.jour||'—'}</div></div>
        <div class="anom-meta"><span class="badge ${b.severity}">${b.severity}</span><span class="badge conf">${b.blitz_type||'standard'}</span>${b.consecutive_days>1?'<span class="badge" style="background:rgba(124,58,237,.12);color:var(--purple)">'+b.consecutive_days+' jours</span>':''}</div></div>
        <div class="blitz-metrics">
          <div class="blitz-metric"><div class="bm-val red">${Math.round(b.nb_constats)}</div><div class="bm-lbl">Constats ce jour</div></div>
          <div class="blitz-metric"><div class="bm-val">${b.avg_daily?b.avg_daily.toFixed(1):'—'}</div><div class="bm-lbl">Moyenne/jour</div></div>
          <div class="blitz-metric"><div class="bm-val orange">${ratio}x</div><div class="bm-lbl">Ratio</div></div>
          <div class="blitz-metric"><div class="bm-val blue">${b.z_score?b.z_score.toFixed(1):'—'}</div><div class="bm-lbl">Z-Score</div></div>
        </div>
        <div class="anom-defense">${b.defense_text||''}</div>`;
      list.appendChild(card);
    }
    renderPagination('blitz-pagination',d.page,d.total_pages,loadBlitz);
  }catch(e){list.innerHTML=`<div class="empty">Erreur: ${e.message}</div>`;}
}

/* ===== DAY PATTERNS ===== */
const JOURS=['Dim','Lun','Mar','Mer','Jeu','Ven','Sam'];
const JOURS_FULL=['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'];

function renderDowChart(containerId,distribution){
  const container=document.getElementById(containerId);if(!container)return;container.innerHTML='';
  const ordered=JOURS_FULL.map(j=>({jour:j,nb:distribution[j]?distribution[j].nb:0,pct:distribution[j]?distribution[j].pct:0}));
  const maxPct=Math.max(...ordered.map(d=>d.pct),1);
  for(let i=0;i<ordered.length;i++){const d=ordered[i];const heightPct=(d.pct/maxPct)*100;
    const isSpike=d.pct>20;const isQuiet=d.pct<5;
    const wrap=document.createElement('div');wrap.className='dow-bar-wrap';
    wrap.innerHTML=`<div class="dow-pct">${d.pct.toFixed(1)}%</div><div class="dow-bar ${isSpike?'spike':isQuiet?'quiet':''}" style="height:${Math.max(heightPct,3)}%"></div><div class="dow-label">${JOURS[i]}<br><span style="color:var(--text);font-weight:700">${d.nb.toLocaleString('fr-CA')}</span></div>`;
    container.appendChild(wrap);
  }
}

async function loadPatterns(page){
  const list=document.getElementById('patterns-list');list.innerHTML='<div class="loading">Chargement des patterns...</div>';
  const params=new URLSearchParams();params.set('page',page);params.set('per_page',20);
  const muni=document.getElementById('pat-inp-muni').value.trim();if(muni)params.set('municipality',muni);
  try{
    const r=await fetch(BASE+'/api/day-patterns?'+params);const d=await r.json();
    if(d.error){list.innerHTML=`<div class="empty">Erreur: ${d.error}</div>`;return;}
    document.getElementById('tab-count-pat').textContent=d.total||0;
    document.getElementById('pat-results-count').textContent=d.total+' patterns anormaux';
    if(d.global_distribution&&Object.keys(d.global_distribution).length>0)renderDowChart('global-dow-chart',d.global_distribution);
    if(!d.patterns||d.patterns.length===0){list.innerHTML='<div class="empty">Aucun pattern anormal detecte.</div>';return;}
    list.innerHTML='';
    for(const p of d.patterns){
      const card=document.createElement('div');card.className='pattern-card';
      const chartId='dow-'+p.id;
      let distHTML='';if(p.distribution&&Object.keys(p.distribution).length>0)distHTML=`<div class="dow-chart" id="${chartId}" style="height:120px"></div>`;
      card.innerHTML=`
        <div class="anom-head"><div class="pc-title">${p.nom_municipalite||p.lieu}${p.region_admin?' <span style="color:var(--dim);font-size:11px">('+p.region_admin+')</span>':''}</div>
        <div class="anom-meta"><span class="badge ${p.severity}">${p.severity}</span><span class="badge ${p.pattern_type==='spike'?'high':'low'}">${p.pattern_type==='spike'?'Pic':'Creux'}: ${p.jour_pic||'?'}</span></div></div>
        <div style="display:flex;gap:16px;margin:8px 0;font-size:12px;flex-wrap:wrap">
          <span>Jour pic: <strong style="color:var(--accent)">${p.jour_pic||'—'}</strong></span>
          <span>% observe: <strong style="color:${p.pct_jour_pic>20?'var(--red)':'var(--text)'}">${p.pct_jour_pic.toFixed(1)}%</strong></span>
          <span>% attendu: <strong>${p.pct_attendu.toFixed(1)}%</strong></span>
          <span>Z-score: <strong style="color:var(--orange)">${p.z_score.toFixed(1)}</strong></span>
          <span>Total constats: <strong>${p.total_constats?p.total_constats.toLocaleString('fr-CA'):'—'}</strong></span>
        </div>
        ${distHTML}
        <div class="anom-defense">${p.defense_text||''}</div>`;
      list.appendChild(card);
      if(p.distribution&&Object.keys(p.distribution).length>0){
        setTimeout(()=>{const el=document.getElementById(chartId);if(!el)return;el.innerHTML='';
          const dist=p.distribution;const vals=JOURS_FULL.map(j=>({jour:j,nb:dist[j]?dist[j].nb:0,pct:dist[j]?dist[j].pct:0,z:dist[j]?dist[j].z:0}));
          const maxP=Math.max(...vals.map(v=>v.pct),1);
          for(let i=0;i<vals.length;i++){const v=vals[i];const h=(v.pct/maxP)*100;const cls=v.z>2.5?'spike':v.z<-2.5?'quiet':'';
            const w=document.createElement('div');w.className='dow-bar-wrap';
            w.innerHTML=`<div class="dow-pct">${v.pct.toFixed(1)}%</div><div class="dow-bar ${cls}" style="height:${Math.max(h,3)}%"></div><div class="dow-label">${JOURS[i]}</div>`;
            el.appendChild(w);}
        },10);
      }
    }
    renderPagination('pat-pagination',d.page,d.total_pages,loadPatterns);
  }catch(e){list.innerHTML=`<div class="empty">Erreur: ${e.message}</div>`;}
}

/* ===== OCR ===== */
async function loadOCR(){
  const content=document.getElementById('ocr-content');content.innerHTML='<div class="loading">Chargement...</div>';
  try{
    const r=await fetch(BASE+'/api/ocr-stats');const d=await r.json();
    document.getElementById('ocr-total').textContent=d.total_scans||0;
    document.getElementById('tab-count-ocr').textContent=d.total_scans||0;
    if(d.total_scans===0){
      document.getElementById('ocr-matricules').textContent='0';document.getElementById('ocr-rues').textContent='0';
      content.innerHTML=`<div class="pattern-card"><div class="pc-title">En attente de donnees</div><div class="pc-info">${d.message||'Aucun ticket scanne encore.'}<br><br><strong>Comment ca fonctionne:</strong><br>1. Un client scanne son ticket via le formulaire<br>2. Le OCR (Mindee) extrait les champs: matricule, rue, appareil, etc.<br>3. Les donnees s'accumulent dans <code>tickets_scannes_meta</code><br>4. Apres 100+ scans, on voit emerger les patterns.</div></div>`;return;}
    document.getElementById('ocr-matricules').textContent=d.top_matricules?d.top_matricules.length:0;
    document.getElementById('ocr-rues').textContent=d.top_rues?d.top_rues.length:0;
    let html='';
    if(d.top_matricules&&d.top_matricules.length>0){html+='<div class="stitle">Top matricules policiers</div>';
      for(const m of d.top_matricules)html+=`<div class="pattern-card"><strong>${m.matricule}</strong> (${m.corps||'?'}) — <span style="color:var(--red);font-weight:800">${m.nb_tickets} tickets</span></div>`;}
    if(d.top_rues&&d.top_rues.length>0){html+='<div class="stitle">Top rues ciblees</div>';
      for(const rue of d.top_rues)html+=`<div class="pattern-card"><strong>${rue.rue}</strong> (${rue.ville||'?'}) — <span style="color:var(--orange);font-weight:800">${rue.nb_tickets} tickets</span></div>`;}
    if(d.top_corps&&d.top_corps.length>0){html+='<div class="stitle">Par corps policier</div>';
      for(const c of d.top_corps)html+=`<div class="pattern-card"><strong>${c.corps}</strong> — ${c.nb_tickets} tickets</div>`;}
    content.innerHTML=html||'<div class="empty">Donnees en cours d\'accumulation...</div>';
  }catch(e){content.innerHTML=`<div class="empty">Erreur: ${e.message}</div>`;}
}

/* ===== PAGINATION HELPER ===== */
function renderPagination(containerId,currentPage,totalPages,loadFn){
  const pag=document.getElementById(containerId);pag.innerHTML='';if(totalPages<=1)return;
  for(let p=1;p<=Math.min(totalPages,10);p++){const btn=document.createElement('button');btn.textContent=p;if(p===currentPage)btn.className='active';btn.onclick=()=>loadFn(p);pag.appendChild(btn);}
  if(totalPages>10){const sp=document.createElement('span');sp.textContent=`... ${totalPages}`;sp.style.cssText='color:var(--muted);padding:6px';pag.appendChild(sp);}
}

/* ===== INIT ===== */
loadSummary();loadDetails(1);tabsLoaded.anomalies=true;
</script>
</body>
</html>
