<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticket911 — Analyse de Contraventions</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1e3a5f;
            --primary-light: #2d5a8e;
            --primary-dark: #0f2440;
            --accent: #e63946;
            --accent-dark: #c1121f;
            --gold: #d4a843;
            --gold-light: #f0d060;
            --success: #22c55e;
            --warning: #f59e0b;
            --dark: #0f172a;
            --dark-2: #1e293b;
            --gray: #64748b;
            --gray-light: #94a3b8;
            --gray-lighter: #e2e8f0;
            --gray-bg: #f8fafc;
            --white: #ffffff;
            --radius: 12px;
            --radius-sm: 8px;
            --radius-lg: 20px;
            --shadow: 0 4px 20px rgba(0,0,0,0.08);
            --shadow-lg: 0 10px 40px rgba(0,0,0,0.12);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            color: var(--dark);
            background: var(--white);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }
        a { text-decoration: none; color: inherit; }
        .container { max-width: 960px; margin: 0 auto; padding: 0 24px; }

        /* ============ HEADER ============ */
        .header {
            background: var(--white);
            box-shadow: 0 2px 10px rgba(0,0,0,0.06);
            position: sticky; top: 0; z-index: 1000;
        }
        .header .container {
            display: flex; justify-content: space-between; align-items: center; padding: 12px 24px;
        }
        .logo { display: flex; align-items: center; gap: 10px; font-size: 26px; font-weight: 900; color: var(--primary); }
        .logo span { color: var(--accent); }
        .header-stats { display: flex; gap: 20px; align-items: center; }
        .header-stat { text-align: center; }
        .header-stat .num { font-size: 16px; font-weight: 800; color: var(--primary); display: block; }
        .header-stat .lbl { font-size: 10px; color: var(--gray); text-transform: uppercase; letter-spacing: 0.5px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--success); display: inline-block; animation: pulse 2s infinite; }
        @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.4; } }

        /* ============ HERO ============ */
        .hero {
            background: linear-gradient(160deg, var(--dark) 0%, var(--primary-dark) 50%, var(--primary) 100%);
            color: white; padding: 50px 0 60px; position: relative; overflow: hidden;
        }
        .hero::before {
            content: ''; position: absolute; top: -50%; right: -20%;
            width: 600px; height: 600px;
            background: radial-gradient(circle, rgba(230,57,70,0.12), transparent 70%);
            border-radius: 50%;
        }
        .hero .container { position: relative; z-index: 1; text-align: center; }
        .hero-badge {
            display: inline-flex; align-items: center; gap: 8px;
            background: rgba(212,168,67,0.15); border: 1px solid rgba(212,168,67,0.3);
            border-radius: 50px; padding: 6px 18px; font-size: 12px;
            color: var(--gold-light); font-weight: 600; text-transform: uppercase;
            letter-spacing: 1px; margin-bottom: 16px;
        }
        .hero h1 { font-size: 36px; font-weight: 900; margin-bottom: 10px; }
        .hero h1 em { color: var(--accent); font-style: normal; }
        .hero p { font-size: 16px; color: rgba(255,255,255,0.65); max-width: 560px; margin: 0 auto; }

        /* ============ FORM ============ */
        .form-section { padding: 40px 0 20px; }
        .form-card {
            background: var(--white); border-radius: var(--radius-lg);
            border: 1px solid var(--gray-lighter); padding: 32px;
            box-shadow: var(--shadow); margin-top: -40px; position: relative; z-index: 2;
        }
        .form-title { font-size: 18px; font-weight: 700; margin-bottom: 20px; color: var(--dark); }
        .presets { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 20px; }
        .preset-btn {
            background: var(--gray-bg); border: 1px solid var(--gray-lighter);
            border-radius: 50px; padding: 7px 16px; font-size: 13px; font-weight: 500;
            color: var(--gray); cursor: pointer; transition: var(--transition);
        }
        .preset-btn:hover { border-color: var(--primary); color: var(--primary); background: rgba(30,58,95,0.05); }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        @media (max-width: 640px) { .form-grid { grid-template-columns: 1fr; } }
        .full { grid-column: 1 / -1; }
        label { display: block; font-size: 12px; font-weight: 600; color: var(--gray); margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px; }
        input, select, textarea {
            width: 100%; padding: 11px 14px; background: var(--gray-bg);
            border: 1px solid var(--gray-lighter); border-radius: var(--radius-sm);
            color: var(--dark); font-size: 14px; font-family: inherit; transition: var(--transition);
        }
        input:focus, select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(30,58,95,0.1); }
        .btn-analyze {
            display: flex; width: 100%; justify-content: center; align-items: center; gap: 8px;
            margin-top: 22px; padding: 15px 32px;
            background: var(--accent); border: none; border-radius: 50px;
            color: white; font-size: 16px; font-weight: 700; cursor: pointer;
            transition: var(--transition);
        }
        .btn-analyze:hover { background: var(--accent-dark); transform: translateY(-2px); box-shadow: 0 8px 25px rgba(230,57,70,0.3); }
        .btn-analyze:disabled { opacity: 0.5; cursor: wait; transform: none; box-shadow: none; }

        /* ============ LOADING ============ */
        .loading { text-align: center; padding: 60px 0; display: none; }
        .loading.active { display: block; }
        .spinner {
            width: 44px; height: 44px; border: 3px solid var(--gray-lighter);
            border-top-color: var(--accent); border-radius: 50%;
            animation: spin 0.8s linear infinite; margin: 0 auto 18px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading p { color: var(--gray); font-size: 15px; }
        .loading .sub { color: var(--gray-light); font-size: 12px; margin-top: 6px; }

        /* ============ RESULTS ============ */
        .results { display: none; padding-bottom: 60px; }
        .results.active { display: block; }

        .score-card {
            background: var(--white); border-radius: var(--radius-lg);
            border: 1px solid var(--gray-lighter); padding: 40px;
            box-shadow: var(--shadow); text-align: center; margin-bottom: 24px;
        }
        .score-circle {
            width: 130px; height: 130px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 40px; font-weight: 900; color: var(--white);
            margin: 0 auto 18px; border: 5px solid;
        }
        .score-low { border-color: var(--accent); background: rgba(230,57,70,0.12); color: var(--accent); }
        .score-mid { border-color: var(--warning); background: rgba(245,158,11,0.12); color: var(--warning); }
        .score-high { border-color: var(--success); background: rgba(34,197,94,0.12); color: var(--success); }
        .score-label { font-size: 14px; color: var(--gray); margin-bottom: 14px; }

        .reco-badge {
            display: inline-block; padding: 8px 24px; border-radius: 50px;
            font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
        }
        .reco-payer { background: rgba(230,57,70,0.1); color: var(--accent); border: 1px solid rgba(230,57,70,0.3); }
        .reco-contester { background: rgba(34,197,94,0.1); color: var(--success); border: 1px solid rgba(34,197,94,0.3); }
        .reco-negocier { background: rgba(212,168,67,0.1); color: var(--gold); border: 1px solid rgba(212,168,67,0.3); }

        .pipeline { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; margin: 18px 0; }
        .agent-badge {
            padding: 5px 14px; border-radius: 50px; font-size: 12px; font-weight: 600;
        }
        .agent-pass { background: rgba(34,197,94,0.1); color: var(--success); border: 1px solid rgba(34,197,94,0.25); }
        .agent-fail { background: rgba(230,57,70,0.1); color: var(--accent); border: 1px solid rgba(230,57,70,0.25); }

        .meta-row {
            display: flex; gap: 24px; justify-content: center; flex-wrap: wrap;
            margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--gray-lighter);
        }
        .meta-item { text-align: center; }
        .meta-item .val { font-size: 18px; font-weight: 800; color: var(--primary); }
        .meta-item .lbl { font-size: 11px; color: var(--gray-light); text-transform: uppercase; }

        /* Detail cards */
        .detail-card {
            background: var(--white); border-radius: var(--radius);
            border: 1px solid var(--gray-lighter); padding: 24px;
            box-shadow: var(--shadow); margin-bottom: 16px;
        }
        .detail-card h3 {
            font-size: 13px; font-weight: 700; color: var(--gray);
            text-transform: uppercase; letter-spacing: 1px; margin-bottom: 14px;
            display: flex; align-items: center; gap: 8px;
        }
        .detail-card h3 .icon {
            width: 28px; height: 28px; border-radius: var(--radius-sm);
            display: flex; align-items: center; justify-content: center; font-size: 14px;
        }
        .icon-red { background: rgba(230,57,70,0.1); color: var(--accent); }
        .icon-blue { background: rgba(30,58,95,0.1); color: var(--primary); }
        .icon-gold { background: rgba(212,168,67,0.1); color: var(--gold); }
        .icon-green { background: rgba(34,197,94,0.1); color: var(--success); }

        .detail-card ul { list-style: none; }
        .detail-card li {
            padding: 10px 0; border-bottom: 1px solid var(--gray-bg);
            font-size: 14px; color: var(--dark-2); display: flex; gap: 10px; align-items: flex-start;
        }
        .detail-card li:last-child { border: none; }
        .detail-card li .num {
            min-width: 24px; height: 24px; border-radius: 50%;
            background: var(--gray-bg); color: var(--gray);
            font-size: 12px; font-weight: 700; display: flex;
            align-items: center; justify-content: center;
        }
        .detail-card p { font-size: 14px; color: var(--dark-2); line-height: 1.7; }

        .warning-box {
            background: rgba(245,158,11,0.08); border: 1px solid rgba(245,158,11,0.3);
            border-radius: var(--radius); padding: 14px 18px; margin-top: 16px;
            font-size: 13px; color: #92400e; display: flex; gap: 10px; align-items: flex-start;
        }
        .warning-box .wi { font-size: 18px; }

        .btn-new {
            display: flex; width: 100%; justify-content: center; align-items: center; gap: 8px;
            margin-top: 24px; padding: 14px 32px;
            background: var(--white); border: 2px solid var(--primary);
            border-radius: 50px; color: var(--primary); font-size: 15px; font-weight: 700;
            cursor: pointer; transition: var(--transition);
        }
        .btn-new:hover { background: var(--primary); color: white; }

        /* ============ FOOTER ============ */
        .footer {
            text-align: center; padding: 24px; color: var(--gray-light);
            font-size: 12px; border-top: 1px solid var(--gray-lighter);
        }
    </style>
</head>
<body>

<!-- HEADER -->
<div class="header">
    <div class="container">
        <div class="logo">TICKET<span>911</span></div>
        <div class="header-stats">
            <div class="header-stat"><span class="num" id="statJuris">—</span><span class="lbl">Cas indexes</span></div>
            <div class="header-stat"><span class="num" id="statLois">—</span><span class="lbl">Lois</span></div>
            <div class="header-stat"><span class="num" id="statAnalyses">—</span><span class="lbl">Analyses</span></div>
            <div class="header-stat"><span class="status-dot"></span> <span class="lbl" id="statStatus" style="color:var(--success)">En ligne</span></div>
        </div>
    </div>
</div>

<!-- HERO -->
<div class="hero">
    <div class="container">
        <div class="hero-badge">Systeme multi-agent</div>
        <h1>Analysez votre <em>contravention</em></h1>
        <p>5 agents specialises analysent votre ticket en temps reel avec 24,600+ decisions de jurisprudence canadienne.</p>
    </div>
</div>

<!-- FORM -->
<div class="form-section">
    <div class="container">
        <div class="form-card" id="formCard">
            <div class="form-title">Entrez les details de votre ticket</div>

            <div class="presets">
                <button class="preset-btn" onclick="preset('qc-vitesse')">QC Vitesse 95/70</button>
                <button class="preset-btn" onclick="preset('qc-feu')">QC Feu rouge</button>
                <button class="preset-btn" onclick="preset('on-speed')">ON Speed 130/100</button>
                <button class="preset-btn" onclick="preset('qc-cell')">QC Cellulaire</button>
            </div>

            <div class="form-grid">
                <div class="full">
                    <label>Infraction</label>
                    <input type="text" id="infraction" placeholder="Ex: Exces de vitesse — 95 km/h dans une zone de 70 km/h">
                </div>
                <div>
                    <label>Juridiction</label>
                    <select id="juridiction">
                        <option value="Quebec">Quebec</option>
                        <option value="Ontario">Ontario</option>
                    </select>
                </div>
                <div>
                    <label>Loi applicable</label>
                    <input type="text" id="loi" placeholder="Ex: Code de la securite routiere, art. 299">
                </div>
                <div>
                    <label>Amende</label>
                    <input type="text" id="amende" placeholder="Ex: 175$ + 30$ frais">
                </div>
                <div>
                    <label>Points d'inaptitude</label>
                    <input type="number" id="points" value="2" min="0" max="15">
                </div>
                <div>
                    <label>Lieu</label>
                    <input type="text" id="lieu" placeholder="Ex: Boulevard Henri-Bourassa, Montreal">
                </div>
                <div>
                    <label>Date</label>
                    <input type="date" id="date">
                </div>
                <div>
                    <label>Appareil de mesure</label>
                    <input type="text" id="appareil" placeholder="Ex: Radar fixe, Camera feu rouge">
                </div>
                <div>
                    <label>Vitesse captee (km/h)</label>
                    <input type="number" id="vitesseCaptee" placeholder="95">
                </div>
                <div>
                    <label>Vitesse permise (km/h)</label>
                    <input type="number" id="vitessePermise" placeholder="70">
                </div>
            </div>

            <button class="btn-analyze" id="btnAnalyze" onclick="analyser()">Analyser mon ticket</button>
        </div>
    </div>
</div>

<!-- LOADING -->
<div class="loading" id="loading">
    <div class="container">
        <div class="spinner"></div>
        <p>Analyse en cours...</p>
        <p class="sub">Lecteur &rarr; Lois &rarr; Precedents &rarr; Analyste &rarr; Verificateur</p>
    </div>
</div>

<!-- RESULTS -->
<div class="results" id="results">
    <div class="container">

        <div class="score-card">
            <div class="score-circle" id="scoreCircle">—</div>
            <div class="score-label">Score de contestation</div>
            <div id="recoBadge"></div>
            <div class="pipeline" id="pipelineStatus"></div>
            <div class="meta-row">
                <div class="meta-item"><span class="val" id="metaConfiance">—</span><span class="lbl">Confiance</span></div>
                <div class="meta-item"><span class="val" id="metaPrec">—</span><span class="lbl">Precedents</span></div>
                <div class="meta-item"><span class="val" id="metaLois">—</span><span class="lbl">Lois</span></div>
                <div class="meta-item"><span class="val" id="metaTemps">—</span><span class="lbl">Temps</span></div>
            </div>
        </div>

        <div class="detail-card" id="argsCard" style="display:none">
            <h3><span class="icon icon-red">&#9878;</span> Arguments de defense</h3>
            <ul id="argsList"></ul>
        </div>

        <div class="detail-card" id="stratCard" style="display:none">
            <h3><span class="icon icon-blue">&#9881;</span> Strategie</h3>
            <p id="stratText"></p>
        </div>

        <div class="detail-card" id="explCard" style="display:none">
            <h3><span class="icon icon-gold">&#9432;</span> Explication</h3>
            <p id="explText"></p>
        </div>

        <div class="detail-card" id="loiCard" style="display:none">
            <h3><span class="icon icon-green">&#9733;</span> Loi applicable</h3>
            <p id="loiText"></p>
        </div>

        <div class="detail-card" id="precedentsCard" style="display:none">
            <h3><span class="icon icon-blue">&#128218;</span> Precedents cites</h3>
            <ul id="precedentsList"></ul>
        </div>

        <div id="warningBox" class="warning-box" style="display:none">
            <span class="wi">&#9888;</span>
            <span id="warningText"></span>
        </div>

        <button class="btn-new" onclick="resetForm()">Nouvelle analyse</button>
    </div>
</div>

<div class="footer">
    Ticket911 &mdash; Systeme multi-agent par SeoAI &mdash; 5 agents specialises
</div>

<script>
const API = window.location.origin;

async function loadStats() {
    try {
        const r = await fetch(API+'/api/stats');
        const d = await r.json();
        document.getElementById('statJuris').textContent = (d.jurisprudence_total||0).toLocaleString();
        document.getElementById('statLois').textContent = d.lois_indexees||0;
        document.getElementById('statAnalyses').textContent = d.analyses_effectuees||0;
    } catch(e) {
        document.getElementById('statStatus').textContent = 'Hors ligne';
        document.getElementById('statStatus').style.color = 'var(--accent)';
    }
}
loadStats();

// Auto-demo: si ?demo=1 ou ?demo=2 dans l'URL, lance une analyse automatiquement
const urlParams = new URLSearchParams(window.location.search);
const demoMode = urlParams.get('demo');
if (demoMode) {
    window.addEventListener('load', () => {
        const demoMap = {'1':'qc-vitesse','2':'on-speed','3':'qc-feu','4':'qc-cell'};
        preset(demoMap[demoMode] || 'qc-vitesse');
        setTimeout(() => analyser(), 500);
    });
}

const PRESETS = {
    'qc-vitesse': { infraction:'Exces de vitesse — 95 km/h dans une zone de 70 km/h', juridiction:'Quebec', loi:'Code de la securite routiere, art. 299', amende:'175$ + 30$ frais', points:2, lieu:'Boulevard Henri-Bourassa, Montreal', appareil:'Radar fixe', vitesseCaptee:95, vitessePermise:70 },
    'qc-feu': { infraction:'Ne pas avoir respecte un feu rouge', juridiction:'Quebec', loi:'Code de la securite routiere, art. 328', amende:'150$ + 30$ frais', points:3, lieu:'Intersection Sherbrooke/St-Denis, Montreal', appareil:'Camera feu rouge', vitesseCaptee:'', vitessePermise:'' },
    'on-speed': { infraction:'Speeding — 130 km/h in a 100 km/h zone', juridiction:'Ontario', loi:'Highway Traffic Act, s.128', amende:'$260', points:3, lieu:'Highway 401, Toronto', appareil:'Radar gun', vitesseCaptee:130, vitessePermise:100 },
    'qc-cell': { infraction:'Utilisation du cellulaire au volant', juridiction:'Quebec', loi:'Code de la securite routiere, art. 443.1', amende:'300$ + frais', points:5, lieu:'Rue Sainte-Catherine, Montreal', appareil:'Agent en personne', vitesseCaptee:'', vitessePermise:'' }
};

function preset(k) {
    const p = PRESETS[k];
    document.getElementById('infraction').value = p.infraction;
    document.getElementById('juridiction').value = p.juridiction;
    document.getElementById('loi').value = p.loi;
    document.getElementById('amende').value = p.amende;
    document.getElementById('points').value = p.points;
    document.getElementById('lieu').value = p.lieu;
    document.getElementById('appareil').value = p.appareil;
    document.getElementById('vitesseCaptee').value = p.vitesseCaptee;
    document.getElementById('vitessePermise').value = p.vitessePermise;
}

async function analyser() {
    const infraction = document.getElementById('infraction').value;
    if (!infraction) { alert('Entrez une infraction'); return; }
    const ticket = {
        infraction, juridiction: document.getElementById('juridiction').value,
        loi: document.getElementById('loi').value, amende: document.getElementById('amende').value,
        points_inaptitude: parseInt(document.getElementById('points').value)||0,
        lieu: document.getElementById('lieu').value,
        date: document.getElementById('date').value || new Date().toISOString().split('T')[0],
        appareil: document.getElementById('appareil').value,
        vitesse_captee: parseInt(document.getElementById('vitesseCaptee').value)||0,
        vitesse_permise: parseInt(document.getElementById('vitessePermise').value)||0
    };
    document.getElementById('formCard').style.display = 'none';
    document.getElementById('loading').classList.add('active');
    document.getElementById('results').classList.remove('active');
    try {
        const r = await fetch(API+'/api/analyze', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ticket}) });
        const d = await r.json();
        showResults(d);
    } catch(e) { alert('Erreur: '+e.message); resetForm(); }
}

function showResults(d) {
    document.getElementById('loading').classList.remove('active');
    document.getElementById('results').classList.add('active');
    const score = d.score||0;
    const c = document.getElementById('scoreCircle');
    c.textContent = score+'%';
    c.className = 'score-circle '+(score<30?'score-low':score<60?'score-mid':'score-high');
    const reco = (d.recommandation||'?').toLowerCase();
    const rc = reco.includes('contest')?'reco-contester':reco.includes('negoci')?'reco-negocier':'reco-payer';
    document.getElementById('recoBadge').innerHTML = '<span class="reco-badge '+rc+'">'+(d.recommandation||'?')+'</span>';
    const pl = document.getElementById('pipelineStatus'); pl.innerHTML = '';
    if (d.etapes) for (const [a,s] of Object.entries(d.etapes))
        pl.innerHTML += '<span class="agent-badge '+(s==='OK'?'agent-pass':'agent-fail')+'">'+a+'</span>';
    document.getElementById('metaConfiance').textContent = (d.confiance||0)+'%';
    document.getElementById('metaPrec').textContent = d.precedents_trouves||0;
    document.getElementById('metaLois').textContent = d.lois_trouvees||0;
    document.getElementById('metaTemps').textContent = (d.temps||0).toFixed(1)+'s';
    const a = d.analyse||{};
    const args = a.arguments||[];
    if (args.length) { document.getElementById('argsCard').style.display='block'; document.getElementById('argsList').innerHTML = args.map((x,i)=>'<li><span class="num">'+(i+1)+'</span><span>'+x+'</span></li>').join(''); }
    if (a.strategie) { document.getElementById('stratCard').style.display='block'; document.getElementById('stratText').textContent = a.strategie; }
    if (a.explication) { document.getElementById('explCard').style.display='block'; document.getElementById('explText').textContent = a.explication; }
    if (a.loi_applicable) { document.getElementById('loiCard').style.display='block'; document.getElementById('loiText').textContent = a.loi_applicable; }
    const precs = a.precedents_cites||[];
    if (precs.length) { document.getElementById('precedentsCard').style.display='block'; document.getElementById('precedentsList').innerHTML = precs.map(p=>'<li><strong>'+( p.citation||'?')+'</strong> — '+(p.resultat||'?')+(p.pertinence?'<br><span style="color:var(--gray);font-size:12px">'+p.pertinence+'</span>':'')+'</li>').join(''); }
    const w = a.avertissement||(d.verification&&d.verification.avertissement);
    if (w) { document.getElementById('warningBox').style.display='flex'; document.getElementById('warningText').textContent = w; }
    loadStats();
}

function resetForm() {
    document.getElementById('formCard').style.display='block';
    document.getElementById('results').classList.remove('active');
    document.getElementById('loading').classList.remove('active');
    ['argsCard','stratCard','explCard','loiCard','precedentsCard'].forEach(id=>document.getElementById(id).style.display='none');
    document.getElementById('warningBox').style.display='none';
}
</script>
</body>
</html>
