<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticket911 — Analyse AI de Contraventions</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, sans-serif; background: #0f1923; color: #e0e0e0; min-height: 100vh; }

        .header {
            background: linear-gradient(135deg, #1e3a5f 0%, #0f1923 100%);
            border-bottom: 2px solid #e63946;
            padding: 20px 0;
            text-align: center;
        }
        .header h1 { color: #fff; font-size: 28px; letter-spacing: 2px; }
        .header h1 span { color: #e63946; }
        .header p { color: #d4a843; font-size: 14px; margin-top: 5px; }

        .container { max-width: 900px; margin: 0 auto; padding: 30px 20px; }

        .stats-bar {
            display: flex; gap: 15px; margin-bottom: 30px; flex-wrap: wrap;
        }
        .stat-card {
            flex: 1; min-width: 120px;
            background: #1a2a3a; border: 1px solid #2a3a4a; border-radius: 8px;
            padding: 15px; text-align: center;
        }
        .stat-card .num { font-size: 24px; font-weight: 700; color: #d4a843; }
        .stat-card .label { font-size: 11px; color: #888; margin-top: 4px; text-transform: uppercase; }

        .form-section {
            background: #1a2a3a; border: 1px solid #2a3a4a; border-radius: 10px;
            padding: 25px; margin-bottom: 25px;
        }
        .form-section h2 { color: #d4a843; font-size: 18px; margin-bottom: 20px; }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        @media (max-width: 600px) { .form-grid { grid-template-columns: 1fr; } }

        label { display: block; font-size: 12px; color: #888; margin-bottom: 4px; text-transform: uppercase; }
        input, select, textarea {
            width: 100%; padding: 10px 12px; background: #0f1923; border: 1px solid #2a3a4a;
            border-radius: 6px; color: #e0e0e0; font-size: 14px; font-family: inherit;
        }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #e63946; }
        textarea { resize: vertical; min-height: 60px; }

        .full-width { grid-column: 1 / -1; }

        .btn-analyze {
            display: block; width: 100%; margin-top: 20px; padding: 14px;
            background: linear-gradient(135deg, #e63946, #c0392b); border: none;
            border-radius: 8px; color: #fff; font-size: 16px; font-weight: 600;
            cursor: pointer; letter-spacing: 1px; transition: all 0.3s;
        }
        .btn-analyze:hover { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(230,57,70,0.3); }
        .btn-analyze:disabled { opacity: 0.5; cursor: wait; transform: none; }

        .presets { margin-bottom: 15px; }
        .presets button {
            background: #0f1923; border: 1px solid #2a3a4a; border-radius: 20px;
            color: #d4a843; padding: 6px 14px; font-size: 12px; cursor: pointer;
            margin: 3px; transition: all 0.2s;
        }
        .presets button:hover { border-color: #d4a843; background: #1e3a5f; }

        /* Results */
        .result-section { display: none; }
        .result-section.active { display: block; }

        .score-display {
            text-align: center; padding: 30px; margin-bottom: 20px;
            background: #1a2a3a; border-radius: 10px; border: 1px solid #2a3a4a;
        }
        .score-circle {
            width: 120px; height: 120px; border-radius: 50%; margin: 0 auto 15px;
            display: flex; align-items: center; justify-content: center;
            font-size: 36px; font-weight: 700; color: #fff;
            border: 4px solid;
        }
        .score-low { border-color: #e63946; background: rgba(230,57,70,0.15); }
        .score-mid { border-color: #d4a843; background: rgba(212,168,67,0.15); }
        .score-high { border-color: #27ae60; background: rgba(39,174,96,0.15); }

        .reco-badge {
            display: inline-block; padding: 6px 20px; border-radius: 20px;
            font-size: 14px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;
        }
        .reco-payer { background: rgba(230,57,70,0.2); color: #e63946; border: 1px solid #e63946; }
        .reco-contester { background: rgba(39,174,96,0.2); color: #27ae60; border: 1px solid #27ae60; }
        .reco-negocier { background: rgba(212,168,67,0.2); color: #d4a843; border: 1px solid #d4a843; }

        .detail-card {
            background: #1a2a3a; border: 1px solid #2a3a4a; border-radius: 8px;
            padding: 20px; margin-bottom: 15px;
        }
        .detail-card h3 { color: #d4a843; font-size: 14px; margin-bottom: 12px; text-transform: uppercase; }
        .detail-card ul { list-style: none; }
        .detail-card li { padding: 6px 0; border-bottom: 1px solid #0f1923; font-size: 14px; }
        .detail-card li:last-child { border: none; }

        .pipeline-status { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; margin: 15px 0; }
        .agent-badge {
            padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 600;
        }
        .agent-pass { background: rgba(39,174,96,0.2); color: #27ae60; border: 1px solid #27ae60; }
        .agent-fail { background: rgba(230,57,70,0.2); color: #e63946; border: 1px solid #e63946; }

        .meta-info { text-align: center; color: #555; font-size: 12px; margin-top: 10px; }

        .loading {
            text-align: center; padding: 40px;
            background: #1a2a3a; border-radius: 10px; display: none;
        }
        .loading.active { display: block; }
        .spinner {
            width: 40px; height: 40px; border: 3px solid #2a3a4a;
            border-top-color: #e63946; border-radius: 50%;
            animation: spin 0.8s linear infinite; margin: 0 auto 15px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .warning-box {
            background: rgba(212,168,67,0.1); border: 1px solid #d4a843;
            border-radius: 8px; padding: 12px 16px; margin-top: 15px; font-size: 13px; color: #d4a843;
        }

        .footer {
            text-align: center; padding: 20px; color: #444; font-size: 11px;
            border-top: 1px solid #1a2a3a; margin-top: 40px;
        }
        .footer a { color: #d4a843; text-decoration: none; }
    </style>
</head>
<body>

<div class="header">
    <h1>TICKET<span>911</span></h1>
    <p>Analyse AI de contraventions routieres — Systeme multi-agent</p>
</div>

<div class="container">

    <!-- Stats Bar -->
    <div class="stats-bar" id="statsBar">
        <div class="stat-card"><div class="num" id="statJuris">—</div><div class="label">Cas indexes</div></div>
        <div class="stat-card"><div class="num" id="statLois">—</div><div class="label">Lois</div></div>
        <div class="stat-card"><div class="num" id="statAnalyses">—</div><div class="label">Analyses</div></div>
        <div class="stat-card"><div class="num" id="statStatus">—</div><div class="label">Status</div></div>
    </div>

    <!-- Form -->
    <div class="form-section" id="formSection">
        <h2>Analyser un ticket</h2>

        <div class="presets">
            <button onclick="preset('qc-vitesse')">QC Vitesse 95/70</button>
            <button onclick="preset('qc-feu')">QC Feu rouge</button>
            <button onclick="preset('on-speed')">ON Speed 130/100</button>
            <button onclick="preset('qc-cell')">QC Cellulaire</button>
        </div>

        <div class="form-grid">
            <div class="full-width">
                <label>Infraction</label>
                <input type="text" id="infraction" placeholder="Ex: Exces de vitesse — 95 km/h dans une zone de 70 km/h">
            </div>
            <div>
                <label>Juridiction</label>
                <select id="juridiction">
                    <option value="Quebec">Quebec</option>
                    <option value="Ontario">Ontario</option>
                </select>
            </div>
            <div>
                <label>Loi applicable</label>
                <input type="text" id="loi" placeholder="Ex: Code de la securite routiere, art. 299">
            </div>
            <div>
                <label>Amende</label>
                <input type="text" id="amende" placeholder="Ex: 175$ + 30$ frais">
            </div>
            <div>
                <label>Points d'inaptitude</label>
                <input type="number" id="points" value="2" min="0" max="15">
            </div>
            <div>
                <label>Lieu</label>
                <input type="text" id="lieu" placeholder="Ex: Boulevard Henri-Bourassa, Montreal">
            </div>
            <div>
                <label>Date</label>
                <input type="date" id="date">
            </div>
            <div>
                <label>Appareil de mesure</label>
                <input type="text" id="appareil" placeholder="Ex: Radar fixe, Camera feu rouge">
            </div>
            <div>
                <label>Vitesse captee (km/h)</label>
                <input type="number" id="vitesseCaptee" placeholder="95">
            </div>
            <div>
                <label>Vitesse permise (km/h)</label>
                <input type="number" id="vitessePermise" placeholder="70">
            </div>
        </div>

        <button class="btn-analyze" id="btnAnalyze" onclick="analyser()">
            ANALYSER MON TICKET
        </button>
    </div>

    <!-- Loading -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Analyse en cours — 5 agents travaillent...</p>
        <p style="color:#555; font-size:12px; margin-top:8px">Lecteur → Lois → Precedents → Analyste → Verificateur</p>
    </div>

    <!-- Results -->
    <div class="result-section" id="results">
        <div class="score-display">
            <div class="score-circle" id="scoreCircle">—</div>
            <p style="color:#888; margin-bottom:10px">Score de contestation</p>
            <div id="recoBadge"></div>
            <div class="pipeline-status" id="pipelineStatus"></div>
            <div class="meta-info" id="metaInfo"></div>
        </div>

        <div class="detail-card" id="argsCard" style="display:none">
            <h3>Arguments de defense</h3>
            <ul id="argsList"></ul>
        </div>

        <div class="detail-card" id="explCard" style="display:none">
            <h3>Explication</h3>
            <p id="explText" style="font-size:14px; line-height:1.6"></p>
        </div>

        <div class="detail-card" id="precedentsCard" style="display:none">
            <h3>Precedents cites</h3>
            <ul id="precedentsList"></ul>
        </div>

        <div id="warningBox" class="warning-box" style="display:none"></div>

        <button class="btn-analyze" onclick="resetForm()" style="background:linear-gradient(135deg,#1e3a5f,#0f1923); border:1px solid #2a3a4a; margin-top:20px">
            NOUVELLE ANALYSE
        </button>
    </div>

</div>

<div class="footer">
    Ticket911 — Systeme multi-agent par <a href="#">SeoAI</a> | 24,600+ cas reels | Propulse par DeepSeek R1
</div>

<script>
const API = window.location.origin;

// Load stats on page load
async function loadStats() {
    try {
        const res = await fetch(API + '/api/stats');
        const data = await res.json();
        document.getElementById('statJuris').textContent = (data.jurisprudence_total || 0).toLocaleString();
        document.getElementById('statLois').textContent = data.lois_indexees || 0;
        document.getElementById('statAnalyses').textContent = data.analyses_effectuees || 0;
        document.getElementById('statStatus').textContent = 'EN LIGNE';
        document.getElementById('statStatus').style.color = '#27ae60';
    } catch(e) {
        document.getElementById('statStatus').textContent = 'ERREUR';
        document.getElementById('statStatus').style.color = '#e63946';
    }
}
loadStats();

// Presets
const PRESETS = {
    'qc-vitesse': {
        infraction: 'Exces de vitesse — 95 km/h dans une zone de 70 km/h',
        juridiction: 'Quebec', loi: 'Code de la securite routiere, art. 299',
        amende: '175$ + 30$ frais', points: 2, lieu: 'Boulevard Henri-Bourassa, Montreal',
        appareil: 'Radar fixe', vitesseCaptee: 95, vitessePermise: 70
    },
    'qc-feu': {
        infraction: 'Ne pas avoir respecte un feu rouge',
        juridiction: 'Quebec', loi: 'Code de la securite routiere, art. 328',
        amende: '150$ + 30$ frais', points: 3, lieu: 'Intersection Sherbrooke/St-Denis, Montreal',
        appareil: 'Camera feu rouge', vitesseCaptee: '', vitessePermise: ''
    },
    'on-speed': {
        infraction: 'Speeding — 130 km/h in a 100 km/h zone',
        juridiction: 'Ontario', loi: 'Highway Traffic Act, s.128',
        amende: '$260', points: 3, lieu: 'Highway 401, Toronto',
        appareil: 'Radar gun', vitesseCaptee: 130, vitessePermise: 100
    },
    'qc-cell': {
        infraction: 'Utilisation du cellulaire au volant',
        juridiction: 'Quebec', loi: 'Code de la securite routiere, art. 443.1',
        amende: '300$ + frais', points: 5, lieu: 'Rue Sainte-Catherine, Montreal',
        appareil: 'Agent en personne', vitesseCaptee: '', vitessePermise: ''
    }
};

function preset(key) {
    const p = PRESETS[key];
    document.getElementById('infraction').value = p.infraction;
    document.getElementById('juridiction').value = p.juridiction;
    document.getElementById('loi').value = p.loi;
    document.getElementById('amende').value = p.amende;
    document.getElementById('points').value = p.points;
    document.getElementById('lieu').value = p.lieu;
    document.getElementById('appareil').value = p.appareil;
    document.getElementById('vitesseCaptee').value = p.vitesseCaptee;
    document.getElementById('vitessePermise').value = p.vitessePermise;
}

async function analyser() {
    const infraction = document.getElementById('infraction').value;
    if (!infraction) { alert('Entrez une infraction'); return; }

    const ticket = {
        infraction: infraction,
        juridiction: document.getElementById('juridiction').value,
        loi: document.getElementById('loi').value,
        amende: document.getElementById('amende').value,
        points_inaptitude: parseInt(document.getElementById('points').value) || 0,
        lieu: document.getElementById('lieu').value,
        date: document.getElementById('date').value || new Date().toISOString().split('T')[0],
        appareil: document.getElementById('appareil').value,
        vitesse_captee: parseInt(document.getElementById('vitesseCaptee').value) || 0,
        vitesse_permise: parseInt(document.getElementById('vitessePermise').value) || 0
    };

    // Show loading
    document.getElementById('formSection').style.display = 'none';
    document.getElementById('loading').classList.add('active');
    document.getElementById('results').classList.remove('active');
    document.getElementById('btnAnalyze').disabled = true;

    try {
        const res = await fetch(API + '/api/analyze', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ticket})
        });
        const data = await res.json();
        showResults(data);
    } catch(e) {
        alert('Erreur: ' + e.message);
        resetForm();
    }
}

function showResults(data) {
    document.getElementById('loading').classList.remove('active');
    document.getElementById('results').classList.add('active');

    const score = data.score || 0;
    const circle = document.getElementById('scoreCircle');
    circle.textContent = score + '%';
    circle.className = 'score-circle ' + (score < 30 ? 'score-low' : score < 60 ? 'score-mid' : 'score-high');

    // Recommendation badge
    const reco = (data.recommandation || '?').toLowerCase();
    const recoEl = document.getElementById('recoBadge');
    const recoClass = reco.includes('contest') ? 'reco-contester' : reco.includes('negoci') ? 'reco-negocier' : 'reco-payer';
    recoEl.innerHTML = '<span class="reco-badge ' + recoClass + '">' + (data.recommandation || '?') + '</span>';

    // Pipeline status
    const pipeline = document.getElementById('pipelineStatus');
    pipeline.innerHTML = '';
    if (data.etapes) {
        for (const [agent, status] of Object.entries(data.etapes)) {
            const cls = status === 'OK' ? 'agent-pass' : 'agent-fail';
            pipeline.innerHTML += '<span class="agent-badge ' + cls + '">' + agent + '</span>';
        }
    }

    // Meta
    document.getElementById('metaInfo').textContent =
        'Confiance: ' + (data.confiance || 0) + '% | ' +
        'Precedents: ' + (data.precedents_trouves || 0) + ' | ' +
        'Lois: ' + (data.lois_trouvees || 0) + ' | ' +
        'Temps: ' + (data.temps || 0).toFixed(1) + 's';

    // Arguments
    const analyse = data.analyse || {};
    const args = analyse.arguments || [];
    if (args.length) {
        document.getElementById('argsCard').style.display = 'block';
        document.getElementById('argsList').innerHTML = args.map(a => '<li>' + a + '</li>').join('');
    }

    // Explication
    if (analyse.explication) {
        document.getElementById('explCard').style.display = 'block';
        document.getElementById('explText').textContent = analyse.explication;
    }

    // Precedents
    const precs = analyse.precedents_cites || [];
    if (precs.length) {
        document.getElementById('precedentsCard').style.display = 'block';
        document.getElementById('precedentsList').innerHTML = precs.map(p =>
            '<li><strong>' + (p.citation || '?') + '</strong> — ' + (p.resultat || '?') +
            (p.pertinence ? '<br><span style="color:#888;font-size:12px">' + p.pertinence + '</span>' : '') + '</li>'
        ).join('');
    }

    // Warning
    const warn = analyse.avertissement || (data.verification && data.verification.avertissement);
    if (warn) {
        document.getElementById('warningBox').style.display = 'block';
        document.getElementById('warningBox').textContent = warn;
    }

    // Refresh stats
    loadStats();
}

function resetForm() {
    document.getElementById('formSection').style.display = 'block';
    document.getElementById('results').classList.remove('active');
    document.getElementById('loading').classList.remove('active');
    document.getElementById('btnAnalyze').disabled = false;
    document.getElementById('argsCard').style.display = 'none';
    document.getElementById('explCard').style.display = 'none';
    document.getElementById('precedentsCard').style.display = 'none';
    document.getElementById('warningBox').style.display = 'none';
}
</script>
</body>
</html>
