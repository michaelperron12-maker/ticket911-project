<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AITicketInfo Admin ‚Äî Dashboard</title>
<style>
:root{--bg:#0f172a;--card:#1e293b;--card2:#334155;--accent:#3b82f6;--green:#22c55e;--yellow:#eab308;--red:#ef4444;--orange:#f97316;--purple:#a78bfa;--cyan:#22d3ee;--text:#e2e8f0;--dim:#94a3b8;--border:#334155;}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Inter',system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;}
.header{background:rgba(15,23,42,.95);border-bottom:1px solid var(--border);padding:16px 24px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:100;backdrop-filter:blur(8px);}
.header h1{font-size:20px;font-weight:800;}.header h1 span{color:var(--accent);}
.status{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--dim);}
.dot{width:8px;height:8px;border-radius:50%;background:var(--green);animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.refresh-btn{background:var(--accent);color:white;border:none;padding:6px 16px;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600;}
.refresh-btn:hover{opacity:.85;}
.grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;padding:18px 24px;max-width:1500px;margin:0 auto;}
.card{background:var(--card);border-radius:12px;padding:18px;border:1px solid var(--border);}
.card h2{font-size:13px;font-weight:700;color:var(--dim);text-transform:uppercase;letter-spacing:.5px;margin-bottom:12px;display:flex;align-items:center;gap:6px;}
.big-num{font-size:32px;font-weight:900;color:white;line-height:1;}
.big-label{font-size:11px;color:var(--dim);margin-top:4px;}
.stat-row{display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid rgba(255,255,255,.04);}
.stat-row:last-child{border:none;}
.stat-key{font-size:12px;color:var(--dim);}
.stat-val{font-size:13px;font-weight:700;color:white;}
.stat-desc{font-size:10px;color:var(--dim);font-weight:400;}
.bar-container{display:flex;align-items:center;gap:6px;margin:3px 0;}
.bar{height:5px;border-radius:3px;transition:width .5s;}
.bar-label{font-size:11px;color:var(--dim);min-width:45px;text-align:right;}
.bar-name{font-size:11px;color:var(--text);min-width:80px;}
.alert{padding:8px 12px;border-radius:6px;margin-bottom:6px;font-size:12px;display:flex;align-items:center;gap:6px;}
.alert.critical{background:rgba(239,68,68,.15);border:1px solid rgba(239,68,68,.3);color:#fca5a5;}
.alert.warning{background:rgba(234,179,8,.12);border:1px solid rgba(234,179,8,.3);color:#fde047;}
.alert.info{background:rgba(59,130,246,.12);border:1px solid rgba(59,130,246,.3);color:#93c5fd;}
.quota-bar{width:100%;height:10px;background:var(--card2);border-radius:5px;overflow:hidden;margin:8px 0;}
.quota-fill{height:100%;border-radius:5px;transition:width .5s;}
.loading{text-align:center;padding:40px;color:var(--dim);font-size:15px;grid-column:span 4;}
.span2{grid-column:span 2;}
.span3{grid-column:span 3;}
.span4{grid-column:span 4;}
.log-box{background:#0a0e1a;border-radius:6px;padding:10px;font-family:'Fira Code',monospace;font-size:10px;color:#86efac;max-height:160px;overflow-y:auto;white-space:pre-wrap;word-break:break-all;}
.badge{display:inline-block;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600;}
.badge-green{background:rgba(34,197,94,.15);color:#86efac;}
.badge-yellow{background:rgba(234,179,8,.15);color:#fde047;}
.badge-red{background:rgba(239,68,68,.15);color:#fca5a5;}
.badge-blue{background:rgba(59,130,246,.15);color:#93c5fd;}
.tag{display:inline-block;background:var(--card2);padding:2px 8px;border-radius:4px;font-size:11px;margin:2px 3px 2px 0;}
@media(max-width:1200px){.grid{grid-template-columns:repeat(2,1fr);}.span3,.span4{grid-column:span 2;}}
@media(max-width:768px){.grid{grid-template-columns:1fr;}.span2,.span3,.span4{grid-column:span 1;}}
</style>
</head>
<body>

<div class="header">
    <h1><span>AITicketInfo</span> Dashboard</h1>
    <div style="display:flex;align-items:center;gap:16px;">
        <div class="status"><div class="dot" id="statusDot"></div><span id="statusText">Chargement...</span></div>
        <button class="refresh-btn" onclick="loadData()">Rafraichir</button>
    </div>
</div>

<div id="content" class="grid">
    <div class="loading">Chargement des donnees...</div>
</div>

<script>
const API = window.location.origin + '/api/monitor';
let refreshInterval;

async function loadData() {
    try {
        const r = await fetch(API);
        const d = await r.json();
        if (d.status === 'error') throw new Error(d.error);
        render(d);
        document.getElementById('statusDot').style.background = '#22c55e';
        document.getElementById('statusText').textContent = `En ligne ‚Äî ${new Date(d.timestamp).toLocaleTimeString('fr-CA')}`;
    } catch(e) {
        document.getElementById('statusDot').style.background = '#ef4444';
        document.getElementById('statusText').textContent = 'Erreur: ' + e.message;
    }
}

function fmt(n) { return (n || 0).toLocaleString('fr-CA'); }

function render(d) {
    const db = d.db || {};
    const tables = db.tables || {};
    const desc = db.tables_desc || {};
    const juris = db.jurisprudence || {};
    const emb = d.embeddings || {};
    const analyses = d.analyses || {};
    const stats = analyses.stats || {};
    const canlii = d.canlii || {};
    const alertes = d.alertes || [];
    const cron = d.cron || {};

    // Quota
    const quotaUsed = canlii.used_today || 0;
    const quotaMax = canlii.daily_max || 4800;
    const quotaPct = Math.min(100, (quotaUsed / quotaMax * 100));
    const quotaColor = quotaPct > 90 ? '#ef4444' : quotaPct > 70 ? '#eab308' : '#22c55e';

    // Embed
    const embedPct = emb.pct || 0;
    const embedColor = embedPct >= 100 ? '#22c55e' : embedPct > 50 ? '#eab308' : '#ef4444';

    // Tables sorted by count desc
    const tablesSorted = Object.entries(tables).sort((a,b) => b[1] - a[1]);

    // Tribunal bars
    const tribunaux = juris.par_tribunal || {};
    const maxTrib = Math.max(...Object.values(tribunaux), 1);
    let tribBars = '';
    const tribColors = ['#3b82f6','#22c55e','#eab308','#f97316','#a78bfa','#22d3ee','#ec4899','#84cc16'];
    Object.entries(tribunaux).slice(0,10).forEach(([k,v], i) => {
        const pct = (v / maxTrib * 100).toFixed(0);
        tribBars += `<div class="bar-container">
            <span class="bar-name">${k}</span>
            <div style="flex:1;background:#334155;border-radius:3px;height:5px;"><div class="bar" style="width:${pct}%;background:${tribColors[i%tribColors.length]};"></div></div>
            <span class="bar-label">${fmt(v)}</span>
        </div>`;
    });

    // Resultat bars
    const resultats = juris.par_resultat || {};
    const maxRes = Math.max(...Object.values(resultats), 1);
    const resColors = {acquitte:'#22c55e', coupable:'#ef4444', rejete:'#f97316', reduit:'#eab308', inconnu:'#64748b', reference:'#a78bfa', negociation:'#22d3ee'};
    let resBars = '';
    Object.entries(resultats).forEach(([k,v]) => {
        const pct = (v / maxRes * 100).toFixed(0);
        resBars += `<div class="bar-container">
            <span class="bar-name">${k}</span>
            <div style="flex:1;background:#334155;border-radius:3px;height:5px;"><div class="bar" style="width:${pct}%;background:${resColors[k]||'#3b82f6'};"></div></div>
            <span class="bar-label">${fmt(v)}</span>
        </div>`;
    });

    // Province tags
    const provTags = Object.entries(juris.par_province || {}).map(([k,v]) =>
        `<span class="tag"><strong>${fmt(v)}</strong> ${k}</span>`
    ).join('');

    // Alertes
    let alertHtml = alertes.length === 0 ? '<div class="alert info">Aucune alerte</div>' : '';
    alertes.forEach(a => {
        const icon = a.level === 'critical' ? 'üî¥' : a.level === 'warning' ? 'üü°' : 'üîµ';
        alertHtml += `<div class="alert ${a.level}">${icon} ${a.msg}</div>`;
    });

    // Tables HTML
    let tablesHtml = '';
    tablesSorted.forEach(([k,v]) => {
        const d2 = desc[k] || '';
        tablesHtml += `<div class="stat-row">
            <span class="stat-key">${k} <span class="stat-desc">${d2}</span></span>
            <span class="stat-val">${v >= 0 ? fmt(v) : 'N/A'}</span>
        </div>`;
    });

    // Imports par jour
    const imports = juris.imports_par_jour || {};
    let importsHtml = '';
    Object.entries(imports).slice(0,7).forEach(([k,v]) => {
        importsHtml += `<div class="stat-row"><span class="stat-key">${k}</span><span class="stat-val">+${fmt(v)}</span></div>`;
    });

    document.getElementById('content').innerHTML = `
        <!-- Row 1: 4 big cards -->
        <div class="card">
            <h2>üìä Base de donnees</h2>
            <div class="big-num">${fmt(db.total_rows || 0)}</div>
            <div class="big-label">lignes totales (16 tables)</div>
        </div>

        <div class="card">
            <h2>‚öñÔ∏è Jurisprudence</h2>
            <div class="big-num">${fmt(tables.jurisprudence || 0)}</div>
            <div class="big-label">decisions de cour</div>
            <div style="margin-top:8px;">${provTags}</div>
        </div>

        <div class="card">
            <h2>üß† Embeddings RAG</h2>
            <div class="big-num" style="color:${embedColor}">${embedPct}%</div>
            <div class="big-label">${fmt(emb.embedded)} / ${fmt(emb.total)} dossiers</div>
            <div class="quota-bar"><div class="quota-fill" style="width:${embedPct}%;background:${embedColor};"></div></div>
            <div class="stat-row"><span class="stat-key">Manquants</span><span class="stat-val">${fmt(emb.missing)}</span></div>
            <div class="stat-row"><span class="stat-key">Modele</span><span class="stat-val" style="font-size:10px;">${emb.model || '?'}</span></div>
            <div class="stat-row"><span class="stat-key">Store</span><span class="stat-val">${emb.store || '?'} (${emb.dims || '?'}d)</span></div>
        </div>

        <div class="card">
            <h2>üì° Quota CanLII</h2>
            <div class="big-num" style="color:${quotaColor}">${fmt(canlii.remaining)}</div>
            <div class="big-label">requetes restantes</div>
            <div class="quota-bar"><div class="quota-fill" style="width:${quotaPct}%;background:${quotaColor};"></div></div>
            <div class="stat-row"><span class="stat-key">Utilisees</span><span class="stat-val">${fmt(quotaUsed)} / ${fmt(quotaMax)}</span></div>
            <div class="stat-row"><span class="stat-key">Dernier appel</span><span class="stat-val" style="font-size:10px;">${canlii.last_update || '?'}</span></div>
        </div>

        <!-- Row 2: Tables + Tribunaux + Resultats -->
        <div class="card span2">
            <h2>üóÑÔ∏è Tables (16)</h2>
            ${tablesHtml}
        </div>

        <div class="card">
            <h2>üèõÔ∏è Par tribunal</h2>
            ${tribBars}
        </div>

        <div class="card">
            <h2>üìã Par resultat</h2>
            ${resBars}
        </div>

        <!-- Row 3: Alertes + Imports + Analyses + Cron -->
        <div class="card">
            <h2>üö® Alertes</h2>
            ${alertHtml}
        </div>

        <div class="card">
            <h2>üì• Imports 7 jours</h2>
            ${importsHtml || '<div class="stat-row"><span class="stat-key">Aucun import recent</span></div>'}
        </div>

        <div class="card">
            <h2>üîç Analyses</h2>
            <div class="stat-row"><span class="stat-key">Total</span><span class="stat-val">${stats.total || 0}</span></div>
            <div class="stat-row"><span class="stat-key">Score moyen</span><span class="stat-val">${stats.score_moyen || 0}%</span></div>
            <div class="stat-row"><span class="stat-key">Confiance</span><span class="stat-val">${stats.confiance_moyenne || 0}%</span></div>
            <div class="stat-row"><span class="stat-key">Temps moyen</span><span class="stat-val">${stats.temps_moyen || 0}s</span></div>
        </div>

        <div class="card">
            <h2>‚è∞ Cron Schedule</h2>
            <div class="stat-row"><span class="stat-key">Import CanLII</span><span class="stat-val" style="font-size:11px;">1h00 AM</span></div>
            <div class="stat-row"><span class="stat-key">Embeddings</span><span class="stat-val" style="font-size:11px;">1h30 AM</span></div>
            <div class="stat-row"><span class="stat-key">Limite/jour</span><span class="stat-val">4,800 req</span></div>
            <div class="stat-row"><span class="stat-key">Modele AI</span><span class="stat-val" style="font-size:11px;">GLM-5 744B</span></div>
        </div>

        <!-- Row 4: Logs -->
        <div class="card span2">
            <h2>üìú Log Import CanLII</h2>
            <div class="log-box">${(d.last_import_log || 'Aucun').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>
        </div>

        <div class="card span2">
            <h2>üß† Log Embeddings</h2>
            <div class="log-box">${(d.last_embed_log || 'Pas encore execute').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>
        </div>
    `;
}

loadData();
refreshInterval = setInterval(loadData, 30000);
</script>
</body>
</html>
